# 香港适宜建设土地选址综合分析系统 - 整体架构设计方案

## 一、项目概述

### 1.1 项目定位
基于ArcGIS Pro Add-in SDK的二次开发项目，实现香港地区适宜建设土地的智能选址分析功能。

### 1.2 技术栈
- **开发语言**: C# (.NET 6.0)
- **UI框架**: WPF (Windows Presentation Foundation)
- **GIS平台**: ArcGIS Pro SDK
- **架构模式**: MVVM (Model-View-ViewModel)

### 1.3 核心功能
1. 基于约束条件划分可建设土地
2. POI距离计算与评分
3. 综合评分与选址推荐

---

## 二、系统架构设计

### 2.1 总体架构图

```
HK_AREA_SEARCH/
├── Module1.cs                          # ArcGIS Pro插件入口模块
├── Config.daml                         # 插件配置文件
│
├── UI Layer (用户界面层)
│   ├── Views/                          # XAML视图
│   │   ├── main_dockpane.xaml         # 主界面Dockpane
│   │   └── CustomIntervalDialog.xaml  # 自定义间隔对话框
│   ├── ViewModels/                     # 视图模型
│   │   ├── main_dockpaneViewModel.cs  # 主界面逻辑
│   │   └── CustomIntervalDialogViewModel.cs
│   └── Converters/                     # 数据转换器
│       ├── BooleanToYesNoConverter.cs
│       ├── WeightSumValidationConverter.cs
│       └── DoubleToFormattedStringConverter.cs
│
├── Models (数据模型层)
│   ├── ConstraintDataItem.cs          # 约束条件数据模型
│   ├── POIDataItem.cs                 # POI数据模型
│   ├── IntervalClassItem.cs           # 间隔分类模型
│   └── AnalysisResult.cs              # 分析结果模型 [待创建]
│
├── Business Logic Layer (业务逻辑层)
│   ├── Divide/                         # 模块1: 可建设土地划分
│   │   ├── IDivideService.cs          # 接口定义
│   │   ├── DivideService.cs           # 核心服务实现
│   │   ├── GeometryProcessor.cs       # 几何处理器
│   │   └── ConstraintMerger.cs        # 约束条件合并器
│   │
│   ├── Distance/                       # 模块2: POI距离计算
│   │   ├── IDistanceService.cs        # 接口定义
│   │   ├── DistanceService.cs         # 核心服务实现
│   │   ├── EuclideanDistanceCalculator.cs  # 欧氏距离计算器
│   │   ├── RasterReclassifier.cs      # 栅格重分类器
│   │   └── NoDataHandler.cs           # NoData值处理器
│   │
│   └── Rating/                         # 模块3: 评分计算
│       ├── IRatingService.cs          # 接口定义
│       ├── RatingService.cs           # 核心服务实现
│       ├── RasterCalculator.cs        # 栅格计算器
│       ├── RasterToVectorConverter.cs # 栅格转矢量
│       └── IntersectionAnalyzer.cs    # 相交分析器
│
├── Infrastructure Layer (基础设施层)
│   ├── Helpers/                        # 辅助工具
│   │   ├── DragDropHelper.cs          # 拖拽辅助
│   │   ├── FilePathHelper.cs          # 文件路径辅助 [待创建]
│   │   ├── GeoprocessingHelper.cs     # 地理处理辅助 [待创建]
│   │   └── ValidationHelper.cs        # 验证辅助 [待创建]
│   │
│   ├── Services/                       # 通用服务
│   │   ├── TempFileManager.cs         # 临时文件管理器 [待创建]
│   │   ├── LayerManager.cs            # 图层管理器 [待创建]
│   │   ├── SymbologyManager.cs        # 符号系统管理器 [待创建]
│   │   └── LogService.cs              # 日志服务 [待创建]
│   │
│   └── Common/                         # 公共组件
│       ├── RelayCommand.cs            # 命令基类
│       ├── Constants.cs               # 常量定义 [待创建]
│       └── Enums.cs                   # 枚举定义 [待创建]
│
└── Configuration/                      # 配置管理
    ├── AnalysisConfig.cs              # 分析配置 [待创建]
    └── PathConfig.cs                  # 路径配置 [待创建]
```

---

## 三、模块详细设计

### 3.1 模块1: Divide (可建设土地划分)

#### 3.1.1 功能职责
将地区数据与约束条件数据进行空间交集取反操作，得到可建设土地矢量数据。

#### 3.1.2 类设计

**IDivideService.cs** - 接口定义
```csharp
namespace HK_AREA_SEARCH.Divide
{
    /// <summary>
    /// 可建设土地划分服务接口
    /// </summary>
    public interface IDivideService
    {
        /// <summary>
        /// 执行可建设土地划分
        /// </summary>
        /// <param name="analysisAreaPath">分析区域路径</param>
        /// <param name="constraintPaths">约束条件路径列表</param>
        /// <param name="outputPath">输出路径</param>
        /// <returns>生成的可建设土地文件路径</returns>
        Task<string> ExecuteAsync(string analysisAreaPath, List<string> constraintPaths, string outputPath);
    }
}
```

**DivideService.cs** - 核心服务
- 职责：协调整个划分流程
- 方法：
  - `ExecuteAsync()`: 主执行方法
  - `ValidateInputs()`: 验证输入数据
  - `MergeConstraints()`: 合并约束条件
  - `PerformDifference()`: 执行差集运算

**GeometryProcessor.cs** - 几何处理器
- 职责：执行几何运算
- 方法：
  - `Union()`: 合并多个要素
  - `Difference()`: 差集运算
  - `Simplify()`: 简化几何

**ConstraintMerger.cs** - 约束条件合并器
- 职责：合并多个约束条件图层
- 方法：
  - `MergeMultipleLayers()`: 合并多个图层
  - `CreateTempLayer()`: 创建临时图层

---

### 3.2 模块2: Distance (POI距离计算)

#### 3.2.1 功能职责
计算POI的欧氏距离、执行栅格重分类、处理NoData值。

#### 3.2.2 类设计

**IDistanceService.cs** - 接口定义
```csharp
namespace HK_AREA_SEARCH.Distance
{
    /// <summary>
    /// 距离计算服务接口
    /// </summary>
    public interface IDistanceService
    {
        /// <summary>
        /// 执行距离计算流程
        /// </summary>
        /// <param name="poiItems">POI数据项列表</param>
        /// <returns>处理后的栅格路径字典</returns>
        Task<Dictionary<string, string>> ExecuteAsync(List<POIDataItem> poiItems);
    }
}
```

**DistanceService.cs** - 核心服务
- 职责：协调距离计算流程
- 方法：
  - `ExecuteAsync()`: 主执行方法
  - `ProcessPOIItem()`: 处理单个POI项
  - `DetermineDataType()`: 判断数据类型

**EuclideanDistanceCalculator.cs** - 欧氏距离计算器
- 职责：计算矢量数据的欧氏距离
- 方法：
  - `CalculateAsync()`: 执行欧氏距离计算
  - `SetMaxDistance()`: 设置最大距离
  - `SaveRaster()`: 保存结果栅格

**RasterReclassifier.cs** - 栅格重分类器
- 职责：对栅格进行重分类
- 方法：
  - `ReclassifyAsync()`: 执行重分类
  - `CreateEqualIntervalClasses()`: 创建等间隔分类
  - `CreateCustomClasses()`: 创建自定义分类
  - `InvertValues()`: 反转分类值

**NoDataHandler.cs** - NoData值处理器
- 职责：处理栅格的NoData值
- 方法：
  - `ReplaceNoDataAsync()`: 替换NoData值
  - `ConvertNoDataToValue()`: 将NoData转为指定值

---

### 3.3 模块3: Rating (评分计算)

#### 3.3.1 功能职责
计算整体评分栅格、转矢量、执行相交分析。

#### 3.3.2 类设计

**IRatingService.cs** - 接口定义
```csharp
namespace HK_AREA_SEARCH.Rating
{
    /// <summary>
    /// 评分计算服务接口
    /// </summary>
    public interface IRatingService
    {
        /// <summary>
        /// 执行评分计算流程
        /// </summary>
        /// <param name="rasterPaths">栅格路径字典</param>
        /// <param name="weights">权重字典</param>
        /// <param name="suitableAreaPath">可建设土地路径</param>
        /// <param name="outputPath">输出路径</param>
        /// <returns>最终结果文件路径</returns>
        Task<string> ExecuteAsync(
            Dictionary<string, string> rasterPaths,
            Dictionary<string, double> weights,
            string suitableAreaPath,
            string outputPath);
    }
}
```

**RatingService.cs** - 核心服务
- 职责：协调评分计算流程
- 方法：
  - `ExecuteAsync()`: 主执行方法
  - `CalculateWeightedSum()`: 计算加权求和
  - `ConvertToVector()`: 转换为矢量
  - `IntersectWithSuitableArea()`: 与可建设土地相交

**RasterCalculator.cs** - 栅格计算器
- 职责：执行栅格代数运算
- 方法：
  - `WeightedSumAsync()`: 加权求和
  - `BuildExpression()`: 构建计算表达式
  - `ExecuteCalculation()`: 执行计算

**RasterToVectorConverter.cs** - 栅格转矢量
- 职责：将栅格数据转为矢量
- 方法：
  - `ConvertAsync()`: 执行转换
  - `SimplifyPolygons()`: 简化面要素
  - `PreserveField()`: 保留字段

**IntersectionAnalyzer.cs** - 相交分析器
- 职责：执行矢量相交分析
- 方法：
  - `IntersectAsync()`: 执行相交
  - `TransferAttributes()`: 传递属性
  - `CalculateArea()`: 计算面积

---

## 四、基础设施层设计

### 4.1 Helpers (辅助工具)

**FilePathHelper.cs** - 文件路径辅助
- 职责：处理文件路径相关操作
- 方法：
  - `GetTempFilePath()`: 生成临时文件路径
  - `ValidatePath()`: 验证路径有效性
  - `ExtractFileName()`: 提取文件名

**GeoprocessingHelper.cs** - 地理处理辅助
- 职责：封装ArcGIS Pro地理处理工具
- 方法：
  - `ExecuteToolAsync()`: 执行GP工具
  - `GetToolParameters()`: 获取工具参数
  - `CheckToolStatus()`: 检查工具状态

**ValidationHelper.cs** - 验证辅助
- 职责：数据验证
- 方法：
  - `ValidateWeightSum()`: 验证权重和
  - `ValidateDataType()`: 验证数据类型
  - `ValidateGeometry()`: 验证几何有效性

### 4.2 Services (通用服务)

**TempFileManager.cs** - 临时文件管理器
- 职责：管理分析过程中的临时文件
- 方法：
  - `CreateTempFile()`: 创建临时文件
  - `RegisterTempFile()`: 注册临时文件
  - `CleanupAll()`: 清理所有临时文件
  - `CleanupByPattern()`: 按模式清理

**LayerManager.cs** - 图层管理器
- 职责：管理地图图层
- 方法：
  - `AddLayerToMap()`: 添加图层到地图
  - `RemoveLayer()`: 移除图层
  - `GetActiveMap()`: 获取活动地图
  - `RefreshLayer()`: 刷新图层

**SymbologyManager.cs** - 符号系统管理器
- 职责：管理图层符号系统
- 方法：
  - `ApplyGraduatedColors()`: 应用多级色彩
  - `SetClassificationField()`: 设置分类字段
  - `CreateColorRamp()`: 创建色带
  - `ApplyRenderer()`: 应用渲染器

**LogService.cs** - 日志服务
- 职责：记录系统日志
- 方法：
  - `LogInfo()`: 记录信息
  - `LogWarning()`: 记录警告
  - `LogError()`: 记录错误
  - `LogProgress()`: 记录进度

---

## 五、数据模型设计

### 5.1 已有模型

**ConstraintDataItem.cs** - 约束条件数据模型
- 属性：
  - `DataPath`: 数据路径
  - `DataName`: 数据名称
  - `IsEmpty`: 是否为空

**POIDataItem.cs** - POI数据模型
- 属性：
  - `DataPath`: 数据路径
  - `DataName`: 数据名称
  - `Distance`: 距离（米）
  - `Weight`: 权重
  - `CustomInterval`: 是否自定义间隔
  - `IsRasterData`: 是否为栅格
  - `IsDistanceEnabled`: 距离是否可编辑
  - `IsEmpty`: 是否为空

**IntervalClassItem.cs** - 间隔分类模型
- 属性：
  - `StartValue`: 开始值
  - `EndValue`: 结束值
  - `ClassValue`: 类别值

### 5.2 待创建模型

**AnalysisResult.cs** - 分析结果模型
```csharp
/// <summary>
/// 分析结果模型
/// </summary>
public class AnalysisResult
{
    /// <summary>
    /// 结果文件路径
    /// </summary>
    public string ResultPath { get; set; }

    /// <summary>
    /// 临时文件列表
    /// </summary>
    public List<string> TempFiles { get; set; }

    /// <summary>
    /// 是否成功
    /// </summary>
    public bool IsSuccess { get; set; }

    /// <summary>
    /// 错误消息
    /// </summary>
    public string ErrorMessage { get; set; }

    /// <summary>
    /// 执行时间（秒）
    /// </summary>
    public double ExecutionTime { get; set; }
}
```

**ProcessingStep.cs** - 处理步骤模型
```csharp
/// <summary>
/// 处理步骤模型
/// </summary>
public class ProcessingStep
{
    /// <summary>
    /// 步骤名称
    /// </summary>
    public string StepName { get; set; }

    /// <summary>
    /// 步骤状态
    /// </summary>
    public StepStatus Status { get; set; }

    /// <summary>
    /// 进度百分比
    /// </summary>
    public int ProgressPercentage { get; set; }

    /// <summary>
    /// 消息
    /// </summary>
    public string Message { get; set; }
}

public enum StepStatus
{
    Pending,
    Running,
    Completed,
    Failed
}
```

---

## 六、工作流程设计

### 6.1 整体流程图

```
用户输入
    ↓
[数据验证]
    ↓
[模块1: Divide] → 生成可建设土地 (Suitable_Area.shp)
    ↓
[模块2: Distance]
    ├─ 计算欧氏距离 → {数据名}_distance.tif
    ├─ 栅格重分类 → {数据名}_reclassification.tif
    └─ 处理NoData → {数据名}_reclassification_ND.tif
    ↓
[模块3: Rating]
    ├─ 加权求和 → {区域名}_rating.tif
    ├─ 转矢量 → {区域名}_rating.shp
    └─ 相交分析 → Result_Rating_Suitable_Area.shp
    ↓
[清理临时文件]
    ↓
[加载结果到地图]
    ↓
[应用符号系统]
    ↓
完成
```

### 6.2 核心算法流程

#### 6.2.1 可建设土地划分流程
```
1. 加载分析区域要素
2. 遍历所有约束条件数据
3. 将所有约束条件合并(Union)
4. 执行分析区域与约束条件的差集(Difference)
5. 保存结果为 Suitable_Area.shp
```

#### 6.2.2 POI距离计算流程
```
对于每个POI项:
    1. 判断数据类型(矢量/栅格)
    2. 如果是矢量:
        a. 计算欧氏距离 → distance.tif
        b. 使用distance.tif作为输入
    3. 如果是栅格:
        a. 直接使用原栅格作为输入
    4. 执行重分类:
        a. 如果不自定义间隔: 使用等间隔分类(10类)
        b. 如果自定义间隔: 弹窗让用户设置
        c. 根据距离正负决定是否反转分类值
    5. 保存重分类结果 → reclassification.tif
    6. 处理NoData值:
        a. 如果距离为正: NoData → 0
        b. 如果距离为负: NoData → 10
    7. 保存最终结果 → reclassification_ND.tif
```

#### 6.2.3 评分计算流程
```
1. 构建加权求和表达式:
    表达式 = (栅格1 × 权重1) + (栅格2 × 权重2) + ...
2. 执行栅格计算 → rating.tif
3. 栅格转矢量(简化面) → rating.shp
4. 与可建设土地相交 → Result_Rating_Suitable_Area.shp
5. 返回结果路径
```

---

## 七、接口交互设计

### 7.1 ViewModel → Services

**main_dockpaneViewModel.cs** 中的 `RunAnalysis()` 方法调用顺序：

```csharp
private async void RunAnalysis(object parameter)
{
    try
    {
        // 1. 数据验证
        var validationResult = ValidationHelper.ValidateInputs(
            AnalysisAreaPath,
            ConstraintItems,
            POIItems,
            OutputPath);

        if (!validationResult.IsValid)
        {
            MessageBox.Show(validationResult.ErrorMessage);
            return;
        }

        // 2. 初始化临时文件管理器
        var tempFileManager = new TempFileManager();

        // 3. 执行模块1: 划分可建设土地
        var divideService = new DivideService(tempFileManager);
        var suitableAreaPath = await divideService.ExecuteAsync(
            AnalysisAreaPath,
            ConstraintItems.Where(c => !c.IsEmpty).Select(c => c.DataPath).ToList(),
            tempFileManager.CreateTempFile("Suitable_Area.shp")
        );

        // 4. 执行模块2: 距离计算
        var distanceService = new DistanceService(tempFileManager);
        var processedRasters = await distanceService.ExecuteAsync(
            POIItems.Where(p => !p.IsEmpty).ToList()
        );

        // 5. 执行模块3: 评分计算
        var ratingService = new RatingService(tempFileManager);
        var weights = POIItems.Where(p => !p.IsEmpty)
            .ToDictionary(p => p.DataName, p => p.Weight.Value);
        var resultPath = await ratingService.ExecuteAsync(
            processedRasters,
            weights,
            suitableAreaPath,
            OutputPath
        );

        // 6. 清理临时文件
        tempFileManager.CleanupAll();

        // 7. 加载结果到地图
        var layerManager = new LayerManager();
        var layer = await layerManager.AddLayerToMap(resultPath);

        // 8. 应用符号系统
        var symbologyManager = new SymbologyManager();
        await symbologyManager.ApplyGraduatedColors(layer, "gridcode");

        // 9. 显示成功消息
        MessageBox.Show("选址分析完成!", "成功");
    }
    catch (Exception ex)
    {
        LogService.LogError($"分析失败: {ex.Message}");
        MessageBox.Show($"分析失败: {ex.Message}", "错误");
    }
}
```

### 7.2 Services内部协作

**Distance模块内部协作示例：**

```
DistanceService
    ↓ 调用
EuclideanDistanceCalculator (如果是矢量)
    ↓ 返回距离栅格路径
DistanceService
    ↓ 调用
RasterReclassifier
    ↓ 返回重分类栅格路径
DistanceService
    ↓ 调用
NoDataHandler
    ↓ 返回最终栅格路径
```

---

## 八、配置管理设计

### 8.1 Constants.cs - 常量定义

```csharp
namespace HK_AREA_SEARCH.Common
{
    /// <summary>
    /// 系统常量
    /// </summary>
    public static class Constants
    {
        // 文件名常量
        public const string SUITABLE_AREA_FILENAME = "Suitable_Area.shp";
        public const string RESULT_FILENAME = "Result_Rating_Suitable_Area.shp";

        // 字段名常量
        public const string RATING_FIELD = "gridcode";
        public const string VALUE_FIELD = "VALUE";

        // 分类常量
        public const int NUM_CLASSES = 10;
        public const string CLASSIFICATION_METHOD = "EQUAL_INTERVAL";

        // 临时文件夹
        public const string TEMP_FOLDER_NAME = "HK_SEARCH_TEMP";

        // 文件后缀
        public const string DISTANCE_SUFFIX = "_distance.tif";
        public const string RECLASS_SUFFIX = "_reclassification.tif";
        public const string NODATA_SUFFIX = "_reclassification_ND.tif";
        public const string RATING_SUFFIX = "_rating.tif";
    }
}
```

### 8.2 Enums.cs - 枚举定义

```csharp
namespace HK_AREA_SEARCH.Common
{
    /// <summary>
    /// 数据类型枚举
    /// </summary>
    public enum DataType
    {
        Vector,
        Raster,
        Unknown
    }

    /// <summary>
    /// 分类方法枚举
    /// </summary>
    public enum ClassificationMethod
    {
        EqualInterval,
        Custom
    }

    /// <summary>
    /// 处理状态枚举
    /// </summary>
    public enum ProcessStatus
    {
        NotStarted,
        InProgress,
        Completed,
        Failed
    }
}
```

---

## 九、错误处理策略

### 9.1 异常处理层次

```
1. UI层 (ViewModel)
   - 捕获所有异常
   - 显示友好的错误消息
   - 记录日志

2. 业务逻辑层 (Services)
   - 抛出业务异常
   - 执行事务回滚
   - 清理资源

3. 基础设施层 (Helpers)
   - 抛出技术异常
   - 提供详细错误信息
```

### 9.2 自定义异常

```csharp
namespace HK_AREA_SEARCH.Exceptions
{
    /// <summary>
    /// 地理处理异常
    /// </summary>
    public class GeoprocessingException : Exception
    {
        public string ToolName { get; set; }
        public Dictionary<string, object> Parameters { get; set; }

        public GeoprocessingException(string message, string toolName)
            : base(message)
        {
            ToolName = toolName;
        }
    }

    /// <summary>
    /// 数据验证异常
    /// </summary>
    public class ValidationException : Exception
    {
        public string FieldName { get; set; }

        public ValidationException(string message, string fieldName)
            : base(message)
        {
            FieldName = fieldName;
        }
    }
}
```

---

## 十、性能优化策略

### 10.1 异步处理
- 所有地理处理操作使用异步方法 (`async/await`)
- 避免阻塞UI线程
- 使用`QueuedTask.Run()`执行ArcGIS Pro操作

### 10.2 资源管理
- 及时释放栅格和要素类资源
- 使用`using`语句管理IDisposable对象
- 临时文件在分析完成后立即删除

### 10.3 缓存策略
- 缓存常用的GP工具参数
- 缓存地图和图层引用
- 避免重复的几何计算

### 10.4 批处理优化
- 合并多个约束条件时使用批处理
- 栅格计算时尽量使用单个表达式完成

---

## 十一、扩展性设计

### 11.1 接口化设计
所有核心服务均定义接口，便于：
- 单元测试时Mock实现
- 未来替换实现方式
- 支持依赖注入

### 11.2 插件化架构
```
未来可扩展模块:
- Population/ (人口密度分析模块)
- Transportation/ (交通便利性分析模块)
- Environment/ (环境质量分析模块)
- Report/ (报告生成模块)
```

### 11.3 配置化
- 分类数量可配置（当前固定10类）
- 色带方案可配置
- 临时文件路径可配置
- 日志级别可配置

---

## 十二、测试策略

### 12.1 单元测试
- Models: 测试数据模型属性变化和验证逻辑
- Helpers: 测试辅助方法的边界条件
- Services: 使用Mock测试业务逻辑

### 12.2 集成测试
- 测试Divide → Distance → Rating完整流程
- 测试临时文件创建和清理
- 测试图层加载和符号化

### 12.3 UI测试
- 测试数据输入验证
- 测试权重和验证
- 测试动态空行管理

---

## 十三、部署结构

### 13.1 编译输出
```
bin/Debug/
├── HK_AREA_SEARCH.dll          # 主程序集
├── Config.daml                  # 配置文件
├── Images/                      # 图标资源
└── DarkImages/                  # 暗色主题图标
```

### 13.2 ArcGIS Pro加载
- 编译后自动复制到ArcGIS Pro Add-ins目录
- 通过Config.daml注册Dockpane和按钮
- Module1.cs作为插件入口点

---

## 十四、开发优先级

### 阶段1: 核心功能实现（高优先级）
1. 完善Models层（已基本完成）
2. 实现Divide模块
3. 实现Distance模块
4. 实现Rating模块

### 阶段2: 基础设施完善（中优先级）
1. TempFileManager实现
2. GeoprocessingHelper实现
3. LayerManager实现
4. SymbologyManager实现

### 阶段3: 增强功能（低优先级）
1. LogService实现
2. 进度条显示
3. 错误详细报告
4. 结果预览功能

---

## 十五、技术要点

### 15.1 ArcGIS Pro SDK关键API

**地理处理工具调用：**
```csharp
using ArcGIS.Desktop.GeoProcessing;

// 异步执行GP工具
var parameters = Geoprocessing.MakeValueArray(input1, input2, output);
var result = await Geoprocessing.ExecuteToolAsync(
    "analysis.Intersect",
    parameters);
```

**栅格操作：**
```csharp
using ArcGIS.Core.Data.Raster;
using ArcGIS.Desktop.Core;

await QueuedTask.Run(() =>
{
    using (Raster raster = RasterDatasetExtensions.OpenRaster(rasterPath))
    {
        // 栅格操作
    }
});
```

**图层管理：**
```csharp
using ArcGIS.Desktop.Mapping;

await QueuedTask.Run(() =>
{
    var map = MapView.Active.Map;
    LayerFactory.Instance.CreateLayer(
        new Uri(featureClassPath),
        map);
});
```

### 15.2 MVVM模式实现要点

- ViewModel继承`DockPane`或`PropertyChangedBase`
- 使用`SetProperty()`触发属性变化通知
- 命令使用`RelayCommand`或`ICommand`实现
- 数据绑定通过XAML的`{Binding}`语法

### 15.3 异步编程模式

```csharp
// ArcGIS Pro操作必须在QueuedTask中执行
await QueuedTask.Run(() =>
{
    // 执行地理处理操作
});

// 长时间运行的任务使用ProgressDialog
var pd = new ProgressDialog("正在处理...");
pd.Show();
try
{
    await Task.Run(() =>
    {
        // 长时间任务
    });
}
finally
{
    pd.Hide();
}
```

---

## 十六、总结

本架构设计方案遵循以下原则：

1. **模块化**: 按照功能需求划分为Divide、Distance、Rating三大模块
2. **分层架构**: UI层、业务逻辑层、基础设施层清晰分离
3. **接口导向**: 核心服务均定义接口，便于测试和扩展
4. **MVVM模式**: UI与业务逻辑分离，符合WPF最佳实践
5. **异步优先**: 所有耗时操作使用异步方法，保证UI响应性
6. **资源管理**: 统一管理临时文件，确保资源及时释放
7. **可扩展性**: 预留扩展接口，支持未来功能增加
8. **错误处理**: 完善的异常处理机制，提供友好的错误提示

通过本架构设计，可以实现一个结构清晰、易于维护、功能完善的ArcGIS Pro选址分析插件。
