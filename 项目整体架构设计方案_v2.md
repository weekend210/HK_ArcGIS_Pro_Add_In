# é¦™æ¸¯é€‚å®œå»ºè®¾åœŸåœ°é€‰å€ç»¼åˆåˆ†æç³»ç»Ÿ - æ•´ä½“æ¶æ„è®¾è®¡æ–¹æ¡ˆ v2.0

> **ç‰ˆæœ¬æ›´æ–°è¯´æ˜**: æœ¬ç‰ˆæœ¬é’ˆå¯¹POIè·ç¦»è®¡ç®—ä¸­çš„æ¬§æ°è·ç¦»åŠŸèƒ½è¿›è¡Œäº†é‡è¦ä¿®æ­£ï¼Œæ˜ç¡®è¦æ±‚æ ¹æ®ç”¨æˆ·è¾“å…¥çš„è·ç¦»å‚æ•°åŠ¨æ€è®¾ç½®æ¬§æ°è·ç¦»è®¡ç®—èŒƒå›´ã€‚

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½
åŸºäºArcGIS Pro Add-in SDKçš„äºŒæ¬¡å¼€å‘é¡¹ç›®,å®ç°é¦™æ¸¯åœ°åŒºé€‚å®œå»ºè®¾åœŸåœ°çš„æ™ºèƒ½é€‰å€åˆ†æåŠŸèƒ½ã€‚

### 1.2 æŠ€æœ¯æ ˆ
- **å¼€å‘è¯­è¨€**: C# (.NET 6.0)
- **UIæ¡†æ¶**: WPF (Windows Presentation Foundation)
- **GISå¹³å°**: ArcGIS Pro SDK
- **æ¶æ„æ¨¡å¼**: MVVM (Model-View-ViewModel)

### 1.3 æ ¸å¿ƒåŠŸèƒ½
1. åŸºäºçº¦æŸæ¡ä»¶åˆ’åˆ†å¯å»ºè®¾åœŸåœ°
2. POIè·ç¦»è®¡ç®—ä¸è¯„åˆ†
3. ç»¼åˆè¯„åˆ†ä¸é€‰å€æ¨è

---

## äºŒã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ€»ä½“æ¶æ„å›¾

```
HK_AREA_SEARCH/
â”œâ”€â”€ Module1.cs                          # ArcGIS Proæ’ä»¶å…¥å£æ¨¡å—
â”œâ”€â”€ Config.daml                         # æ’ä»¶é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ UI Layer (ç”¨æˆ·ç•Œé¢å±‚)
â”‚   â”œâ”€â”€ Views/                          # XAMLè§†å›¾
â”‚   â”‚   â”œâ”€â”€ main_dockpane.xaml         # ä¸»ç•Œé¢Dockpane
â”‚   â”‚   â””â”€â”€ CustomIntervalDialog.xaml  # è‡ªå®šä¹‰é—´éš”å¯¹è¯æ¡†
â”‚   â”œâ”€â”€ ViewModels/                     # è§†å›¾æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ main_dockpaneViewModel.cs  # ä¸»ç•Œé¢é€»è¾‘
â”‚   â”‚   â””â”€â”€ CustomIntervalDialogViewModel.cs
â”‚   â””â”€â”€ Converters/                     # æ•°æ®è½¬æ¢å™¨
â”‚       â”œâ”€â”€ BooleanToYesNoConverter.cs
â”‚       â”œâ”€â”€ WeightSumValidationConverter.cs
â”‚       â””â”€â”€ DoubleToFormattedStringConverter.cs
â”‚
â”œâ”€â”€ Models (æ•°æ®æ¨¡å‹å±‚)
â”‚   â”œâ”€â”€ ConstraintDataItem.cs          # çº¦æŸæ¡ä»¶æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ POIDataItem.cs                 # POIæ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ IntervalClassItem.cs           # é—´éš”åˆ†ç±»æ¨¡å‹
â”‚   â””â”€â”€ AnalysisResult.cs              # åˆ†æç»“æœæ¨¡å‹ [å¾…åˆ›å»º]
â”‚
â”œâ”€â”€ Business Logic Layer (ä¸šåŠ¡é€»è¾‘å±‚)
â”‚   â”œâ”€â”€ Divide/                         # æ¨¡å—1: å¯å»ºè®¾åœŸåœ°åˆ’åˆ†
â”‚   â”‚   â”œâ”€â”€ IDivideService.cs          # æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ DivideService.cs           # æ ¸å¿ƒæœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ GeometryProcessor.cs       # å‡ ä½•å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ ConstraintMerger.cs        # çº¦æŸæ¡ä»¶åˆå¹¶å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ Distance/                       # æ¨¡å—2: POIè·ç¦»è®¡ç®—
â”‚   â”‚   â”œâ”€â”€ IDistanceService.cs        # æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ DistanceService.cs         # æ ¸å¿ƒæœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ EuclideanDistanceCalculator.cs  # æ¬§æ°è·ç¦»è®¡ç®—å™¨ âš ï¸ é‡ç‚¹ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ RasterReclassifier.cs      # æ …æ ¼é‡åˆ†ç±»å™¨
â”‚   â”‚   â””â”€â”€ NoDataHandler.cs           # NoDataå€¼å¤„ç†å™¨
â”‚   â”‚
â”‚   â””â”€â”€ Rating/                         # æ¨¡å—3: è¯„åˆ†è®¡ç®—
â”‚       â”œâ”€â”€ IRatingService.cs          # æ¥å£å®šä¹‰
â”‚       â”œâ”€â”€ RatingService.cs           # æ ¸å¿ƒæœåŠ¡å®ç°
â”‚       â”œâ”€â”€ RasterCalculator.cs        # æ …æ ¼è®¡ç®—å™¨
â”‚       â”œâ”€â”€ RasterToVectorConverter.cs # æ …æ ¼è½¬çŸ¢é‡
â”‚       â””â”€â”€ IntersectionAnalyzer.cs    # ç›¸äº¤åˆ†æå™¨
â”‚
â”œâ”€â”€ Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)
â”‚   â”œâ”€â”€ Helpers/                        # è¾…åŠ©å·¥å…·
â”‚   â”‚   â”œâ”€â”€ DragDropHelper.cs          # æ‹–æ‹½è¾…åŠ©
â”‚   â”‚   â”œâ”€â”€ FilePathHelper.cs          # æ–‡ä»¶è·¯å¾„è¾…åŠ© [å¾…åˆ›å»º]
â”‚   â”‚   â”œâ”€â”€ GeoprocessingHelper.cs     # åœ°ç†å¤„ç†è¾…åŠ© [å¾…åˆ›å»º]
â”‚   â”‚   â””â”€â”€ ValidationHelper.cs        # éªŒè¯è¾…åŠ© [å¾…åˆ›å»º]
â”‚   â”‚
â”‚   â”œâ”€â”€ Services/                       # é€šç”¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ TempFileManager.cs         # ä¸´æ—¶æ–‡ä»¶ç®¡ç†å™¨ [å¾…åˆ›å»º]
â”‚   â”‚   â”œâ”€â”€ LayerManager.cs            # å›¾å±‚ç®¡ç†å™¨ [å¾…åˆ›å»º]
â”‚   â”‚   â”œâ”€â”€ SymbologyManager.cs        # ç¬¦å·ç³»ç»Ÿç®¡ç†å™¨ [å¾…åˆ›å»º]
â”‚   â”‚   â””â”€â”€ LogService.cs              # æ—¥å¿—æœåŠ¡ [å¾…åˆ›å»º]
â”‚   â”‚
â”‚   â””â”€â”€ Common/                         # å…¬å…±ç»„ä»¶
â”‚       â”œâ”€â”€ RelayCommand.cs            # å‘½ä»¤åŸºç±»
â”‚       â”œâ”€â”€ Constants.cs               # å¸¸é‡å®šä¹‰ [å¾…åˆ›å»º]
â”‚       â””â”€â”€ Enums.cs                   # æšä¸¾å®šä¹‰ [å¾…åˆ›å»º]
â”‚
â””â”€â”€ Configuration/                      # é…ç½®ç®¡ç†
    â”œâ”€â”€ AnalysisConfig.cs              # åˆ†æé…ç½® [å¾…åˆ›å»º]
    â””â”€â”€ PathConfig.cs                  # è·¯å¾„é…ç½® [å¾…åˆ›å»º]
```

---

## ä¸‰ã€æ¨¡å—è¯¦ç»†è®¾è®¡

### 3.1 æ¨¡å—1: Divide (å¯å»ºè®¾åœŸåœ°åˆ’åˆ†)

#### 3.1.1 åŠŸèƒ½èŒè´£
å°†åœ°åŒºæ•°æ®ä¸çº¦æŸæ¡ä»¶æ•°æ®è¿›è¡Œç©ºé—´äº¤é›†å–åæ“ä½œ,å¾—åˆ°å¯å»ºè®¾åœŸåœ°çŸ¢é‡æ•°æ®ã€‚

#### 3.1.2 ç±»è®¾è®¡

**IDivideService.cs** - æ¥å£å®šä¹‰
```csharp
namespace HK_AREA_SEARCH.Divide
{
    /// <summary>
    /// å¯å»ºè®¾åœŸåœ°åˆ’åˆ†æœåŠ¡æ¥å£
    /// </summary>
    public interface IDivideService
    {
        /// <summary>
        /// æ‰§è¡Œå¯å»ºè®¾åœŸåœ°åˆ’åˆ†
        /// </summary>
        /// <param name="analysisAreaPath">åˆ†æåŒºåŸŸè·¯å¾„</param>
        /// <param name="constraintPaths">çº¦æŸæ¡ä»¶è·¯å¾„åˆ—è¡¨</param>
        /// <param name="outputPath">è¾“å‡ºè·¯å¾„</param>
        /// <returns>ç”Ÿæˆçš„å¯å»ºè®¾åœŸåœ°æ–‡ä»¶è·¯å¾„</returns>
        Task<string> ExecuteAsync(string analysisAreaPath, List<string> constraintPaths, string outputPath);
    }
}
```

**DivideService.cs** - æ ¸å¿ƒæœåŠ¡
- èŒè´£: åè°ƒæ•´ä¸ªåˆ’åˆ†æµç¨‹
- æ–¹æ³•:
  - `ExecuteAsync()`: ä¸»æ‰§è¡Œæ–¹æ³•
  - `ValidateInputs()`: éªŒè¯è¾“å…¥æ•°æ®
  - `MergeConstraints()`: åˆå¹¶çº¦æŸæ¡ä»¶
  - `PerformDifference()`: æ‰§è¡Œå·®é›†è¿ç®—

**GeometryProcessor.cs** - å‡ ä½•å¤„ç†å™¨
- èŒè´£: æ‰§è¡Œå‡ ä½•è¿ç®—
- æ–¹æ³•:
  - `Union()`: åˆå¹¶å¤šä¸ªè¦ç´ 
  - `Difference()`: å·®é›†è¿ç®—
  - `Simplify()`: ç®€åŒ–å‡ ä½•

**ConstraintMerger.cs** - çº¦æŸæ¡ä»¶åˆå¹¶å™¨
- èŒè´£: åˆå¹¶å¤šä¸ªçº¦æŸæ¡ä»¶å›¾å±‚
- æ–¹æ³•:
  - `MergeMultipleLayers()`: åˆå¹¶å¤šä¸ªå›¾å±‚
  - `CreateTempLayer()`: åˆ›å»ºä¸´æ—¶å›¾å±‚

---

### 3.2 æ¨¡å—2: Distance (POIè·ç¦»è®¡ç®—)

#### 3.2.1 åŠŸèƒ½èŒè´£
è®¡ç®—POIçš„æ¬§æ°è·ç¦»ã€æ‰§è¡Œæ …æ ¼é‡åˆ†ç±»ã€å¤„ç†NoDataå€¼ã€‚

#### 3.2.2 ç±»è®¾è®¡

**IDistanceService.cs** - æ¥å£å®šä¹‰
```csharp
namespace HK_AREA_SEARCH.Distance
{
    /// <summary>
    /// è·ç¦»è®¡ç®—æœåŠ¡æ¥å£
    /// </summary>
    public interface IDistanceService
    {
        /// <summary>
        /// æ‰§è¡Œè·ç¦»è®¡ç®—æµç¨‹
        /// </summary>
        /// <param name="poiItems">POIæ•°æ®é¡¹åˆ—è¡¨</param>
        /// <returns>å¤„ç†åçš„æ …æ ¼è·¯å¾„å­—å…¸</returns>
        Task<Dictionary<string, string>> ExecuteAsync(List<POIDataItem> poiItems);
    }
}
```

**DistanceService.cs** - æ ¸å¿ƒæœåŠ¡
- èŒè´£: åè°ƒè·ç¦»è®¡ç®—æµç¨‹
- æ–¹æ³•:
  - `ExecuteAsync()`: ä¸»æ‰§è¡Œæ–¹æ³•
  - `ProcessPOIItem()`: å¤„ç†å•ä¸ªPOIé¡¹
  - `DetermineDataType()`: åˆ¤æ–­æ•°æ®ç±»å‹

**EuclideanDistanceCalculator.cs** - æ¬§æ°è·ç¦»è®¡ç®—å™¨ âš ï¸ **ã€é‡ç‚¹ä¿®æ”¹ã€‘**
- èŒè´£: è®¡ç®—çŸ¢é‡æ•°æ®çš„æ¬§æ°è·ç¦»
- æ–¹æ³•:
  - `CalculateAsync(string inputPath, double maxDistance, string outputPath)`: æ‰§è¡Œæ¬§æ°è·ç¦»è®¡ç®—
    - **å‚æ•°è¯´æ˜**:
      - `maxDistance`: **æ ¹æ®POIè¾“å…¥ä¸­çš„"è·ç¦»"å­—æ®µ(å–ç»å¯¹å€¼)åŠ¨æ€è®¾ç½®**
      - ä¾‹å¦‚: ç”¨æˆ·è¾“å…¥è·ç¦»ä¸º500ç±³,åˆ™maxDistance=500
      - ä¾‹å¦‚: ç”¨æˆ·è¾“å…¥è·ç¦»ä¸º-800ç±³,åˆ™maxDistance=800
  - `SetMaxDistance(double distance)`: è®¾ç½®æœ€å¤§è·ç¦»å‚æ•°
  - `SaveRaster(string path)`: ä¿å­˜ç»“æœæ …æ ¼

> **ğŸ”´ é‡è¦ä¿®æ”¹ç‚¹**:
> åœ¨åŸæ¶æ„è®¾è®¡æ–¹æ¡ˆä¸­,æ¬§æ°è·ç¦»è®¡ç®—æœªæ˜ç¡®è¯´æ˜éœ€è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„"è·ç¦»"å‚æ•°æ¥è®¾ç½®è®¡ç®—èŒƒå›´ã€‚
> åœ¨æ–°ç‰ˆæœ¬ä¸­,**å¿…é¡»æ ¹æ®POIè¾“å…¥æ•°æ®ä¸­çš„"è·ç¦»"æ (å–ç»å¯¹å€¼)ä½œä¸ºæ¬§æ°è·ç¦»å·¥å…·çš„æœ€å¤§è·ç¦»å‚æ•°**ã€‚
> è¿™æ ·å¯ä»¥ç¡®ä¿è·ç¦»è®¡ç®—çš„ç²¾ç¡®æ€§å’Œçµæ´»æ€§,é¿å…å›ºå®šä½¿ç”¨1000ç±³ç­‰é»˜è®¤å€¼ã€‚

**RasterReclassifier.cs** - æ …æ ¼é‡åˆ†ç±»å™¨
- èŒè´£: å¯¹æ …æ ¼è¿›è¡Œé‡åˆ†ç±»
- æ–¹æ³•:
  - `ReclassifyAsync()`: æ‰§è¡Œé‡åˆ†ç±»
  - `CreateEqualIntervalClasses()`: åˆ›å»ºç­‰é—´éš”åˆ†ç±»
  - `CreateCustomClasses()`: åˆ›å»ºè‡ªå®šä¹‰åˆ†ç±»
  - `InvertValues()`: åè½¬åˆ†ç±»å€¼

**NoDataHandler.cs** - NoDataå€¼å¤„ç†å™¨
- èŒè´£: å¤„ç†æ …æ ¼çš„NoDataå€¼
- æ–¹æ³•:
  - `ReplaceNoDataAsync()`: æ›¿æ¢NoDataå€¼
  - `ConvertNoDataToValue()`: å°†NoDataè½¬ä¸ºæŒ‡å®šå€¼

---

### 3.3 æ¨¡å—3: Rating (è¯„åˆ†è®¡ç®—)

#### 3.3.1 åŠŸèƒ½èŒè´£
è®¡ç®—æ•´ä½“è¯„åˆ†æ …æ ¼ã€è½¬çŸ¢é‡ã€æ‰§è¡Œç›¸äº¤åˆ†æã€‚

#### 3.3.2 ç±»è®¾è®¡

**IRatingService.cs** - æ¥å£å®šä¹‰
```csharp
namespace HK_AREA_SEARCH.Rating
{
    /// <summary>
    /// è¯„åˆ†è®¡ç®—æœåŠ¡æ¥å£
    /// </summary>
    public interface IRatingService
    {
        /// <summary>
        /// æ‰§è¡Œè¯„åˆ†è®¡ç®—æµç¨‹
        /// </summary>
        /// <param name="rasterPaths">æ …æ ¼è·¯å¾„å­—å…¸</param>
        /// <param name="weights">æƒé‡å­—å…¸</param>
        /// <param name="suitableAreaPath">å¯å»ºè®¾åœŸåœ°è·¯å¾„</param>
        /// <param name="outputPath">è¾“å‡ºè·¯å¾„</param>
        /// <returns>æœ€ç»ˆç»“æœæ–‡ä»¶è·¯å¾„</returns>
        Task<string> ExecuteAsync(
            Dictionary<string, string> rasterPaths,
            Dictionary<string, double> weights,
            string suitableAreaPath,
            string outputPath);
    }
}
```

**RatingService.cs** - æ ¸å¿ƒæœåŠ¡
- èŒè´£: åè°ƒè¯„åˆ†è®¡ç®—æµç¨‹
- æ–¹æ³•:
  - `ExecuteAsync()`: ä¸»æ‰§è¡Œæ–¹æ³•
  - `CalculateWeightedSum()`: è®¡ç®—åŠ æƒæ±‚å’Œ
  - `ConvertToVector()`: è½¬æ¢ä¸ºçŸ¢é‡
  - `IntersectWithSuitableArea()`: ä¸å¯å»ºè®¾åœŸåœ°ç›¸äº¤

**RasterCalculator.cs** - æ …æ ¼è®¡ç®—å™¨
- èŒè´£: æ‰§è¡Œæ …æ ¼ä»£æ•°è¿ç®—
- æ–¹æ³•:
  - `WeightedSumAsync()`: åŠ æƒæ±‚å’Œ
  - `BuildExpression()`: æ„å»ºè®¡ç®—è¡¨è¾¾å¼
  - `ExecuteCalculation()`: æ‰§è¡Œè®¡ç®—

**RasterToVectorConverter.cs** - æ …æ ¼è½¬çŸ¢é‡
- èŒè´£: å°†æ …æ ¼æ•°æ®è½¬ä¸ºçŸ¢é‡
- æ–¹æ³•:
  - `ConvertAsync()`: æ‰§è¡Œè½¬æ¢
  - `SimplifyPolygons()`: ç®€åŒ–é¢è¦ç´ 
  - `PreserveField()`: ä¿ç•™å­—æ®µ

**IntersectionAnalyzer.cs** - ç›¸äº¤åˆ†æå™¨
- èŒè´£: æ‰§è¡ŒçŸ¢é‡ç›¸äº¤åˆ†æ
- æ–¹æ³•:
  - `IntersectAsync()`: æ‰§è¡Œç›¸äº¤
  - `TransferAttributes()`: ä¼ é€’å±æ€§
  - `CalculateArea()`: è®¡ç®—é¢ç§¯

---

## å››ã€åŸºç¡€è®¾æ–½å±‚è®¾è®¡

### 4.1 Helpers (è¾…åŠ©å·¥å…·)

**FilePathHelper.cs** - æ–‡ä»¶è·¯å¾„è¾…åŠ©
- èŒè´£: å¤„ç†æ–‡ä»¶è·¯å¾„ç›¸å…³æ“ä½œ
- æ–¹æ³•:
  - `GetTempFilePath()`: ç”Ÿæˆä¸´æ—¶æ–‡ä»¶è·¯å¾„
  - `ValidatePath()`: éªŒè¯è·¯å¾„æœ‰æ•ˆæ€§
  - `ExtractFileName()`: æå–æ–‡ä»¶å

**GeoprocessingHelper.cs** - åœ°ç†å¤„ç†è¾…åŠ©
- èŒè´£: å°è£…ArcGIS Proåœ°ç†å¤„ç†å·¥å…·
- æ–¹æ³•:
  - `ExecuteToolAsync()`: æ‰§è¡ŒGPå·¥å…·
  - `GetToolParameters()`: è·å–å·¥å…·å‚æ•°
  - `CheckToolStatus()`: æ£€æŸ¥å·¥å…·çŠ¶æ€

**ValidationHelper.cs** - éªŒè¯è¾…åŠ©
- èŒè´£: æ•°æ®éªŒè¯
- æ–¹æ³•:
  - `ValidateWeightSum()`: éªŒè¯æƒé‡å’Œ
  - `ValidateDataType()`: éªŒè¯æ•°æ®ç±»å‹
  - `ValidateGeometry()`: éªŒè¯å‡ ä½•æœ‰æ•ˆæ€§

### 4.2 Services (é€šç”¨æœåŠ¡)

**TempFileManager.cs** - ä¸´æ—¶æ–‡ä»¶ç®¡ç†å™¨
- èŒè´£: ç®¡ç†åˆ†æè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶
- æ–¹æ³•:
  - `CreateTempFile()`: åˆ›å»ºä¸´æ—¶æ–‡ä»¶
  - `RegisterTempFile()`: æ³¨å†Œä¸´æ—¶æ–‡ä»¶
  - `CleanupAll()`: æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
  - `CleanupByPattern()`: æŒ‰æ¨¡å¼æ¸…ç†

**LayerManager.cs** - å›¾å±‚ç®¡ç†å™¨
- èŒè´£: ç®¡ç†åœ°å›¾å›¾å±‚
- æ–¹æ³•:
  - `AddLayerToMap()`: æ·»åŠ å›¾å±‚åˆ°åœ°å›¾
  - `RemoveLayer()`: ç§»é™¤å›¾å±‚
  - `GetActiveMap()`: è·å–æ´»åŠ¨åœ°å›¾
  - `RefreshLayer()`: åˆ·æ–°å›¾å±‚

**SymbologyManager.cs** - ç¬¦å·ç³»ç»Ÿç®¡ç†å™¨
- èŒè´£: ç®¡ç†å›¾å±‚ç¬¦å·ç³»ç»Ÿ
- æ–¹æ³•:
  - `ApplyGraduatedColors()`: åº”ç”¨å¤šçº§è‰²å½©
  - `SetClassificationField()`: è®¾ç½®åˆ†ç±»å­—æ®µ
  - `CreateColorRamp()`: åˆ›å»ºè‰²å¸¦
  - `ApplyRenderer()`: åº”ç”¨æ¸²æŸ“å™¨

**LogService.cs** - æ—¥å¿—æœåŠ¡
- èŒè´£: è®°å½•ç³»ç»Ÿæ—¥å¿—
- æ–¹æ³•:
  - `LogInfo()`: è®°å½•ä¿¡æ¯
  - `LogWarning()`: è®°å½•è­¦å‘Š
  - `LogError()`: è®°å½•é”™è¯¯
  - `LogProgress()`: è®°å½•è¿›åº¦

---

## äº”ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 5.1 å·²æœ‰æ¨¡å‹

**ConstraintDataItem.cs** - çº¦æŸæ¡ä»¶æ•°æ®æ¨¡å‹
- å±æ€§:
  - `DataPath`: æ•°æ®è·¯å¾„
  - `DataName`: æ•°æ®åç§°
  - `IsEmpty`: æ˜¯å¦ä¸ºç©º

**POIDataItem.cs** - POIæ•°æ®æ¨¡å‹
- å±æ€§:
  - `DataPath`: æ•°æ®è·¯å¾„
  - `DataName`: æ•°æ®åç§°
  - `Distance`: è·ç¦»(ç±³) âš ï¸ **ã€æ­¤å­—æ®µç”¨äºè®¾ç½®æ¬§æ°è·ç¦»çš„æœ€å¤§è·ç¦»å‚æ•°ã€‘**
  - `Weight`: æƒé‡
  - `CustomInterval`: æ˜¯å¦è‡ªå®šä¹‰é—´éš”
  - `IsRasterData`: æ˜¯å¦ä¸ºæ …æ ¼
  - `IsDistanceEnabled`: è·ç¦»æ˜¯å¦å¯ç¼–è¾‘
  - `IsEmpty`: æ˜¯å¦ä¸ºç©º

**IntervalClassItem.cs** - é—´éš”åˆ†ç±»æ¨¡å‹
- å±æ€§:
  - `StartValue`: å¼€å§‹å€¼
  - `EndValue`: ç»“æŸå€¼
  - `ClassValue`: ç±»åˆ«å€¼

### 5.2 å¾…åˆ›å»ºæ¨¡å‹

**AnalysisResult.cs** - åˆ†æç»“æœæ¨¡å‹
```csharp
/// <summary>
/// åˆ†æç»“æœæ¨¡å‹
/// </summary>
public class AnalysisResult
{
    /// <summary>
    /// ç»“æœæ–‡ä»¶è·¯å¾„
    /// </summary>
    public string ResultPath { get; set; }

    /// <summary>
    /// ä¸´æ—¶æ–‡ä»¶åˆ—è¡¨
    /// </summary>
    public List<string> TempFiles { get; set; }

    /// <summary>
    /// æ˜¯å¦æˆåŠŸ
    /// </summary>
    public bool IsSuccess { get; set; }

    /// <summary>
    /// é”™è¯¯æ¶ˆæ¯
    /// </summary>
    public string ErrorMessage { get; set; }

    /// <summary>
    /// æ‰§è¡Œæ—¶é—´(ç§’)
    /// </summary>
    public double ExecutionTime { get; set; }
}
```

**ProcessingStep.cs** - å¤„ç†æ­¥éª¤æ¨¡å‹
```csharp
/// <summary>
/// å¤„ç†æ­¥éª¤æ¨¡å‹
/// </summary>
public class ProcessingStep
{
    /// <summary>
    /// æ­¥éª¤åç§°
    /// </summary>
    public string StepName { get; set; }

    /// <summary>
    /// æ­¥éª¤çŠ¶æ€
    /// </summary>
    public StepStatus Status { get; set; }

    /// <summary>
    /// è¿›åº¦ç™¾åˆ†æ¯”
    /// </summary>
    public int ProgressPercentage { get; set; }

    /// <summary>
    /// æ¶ˆæ¯
    /// </summary>
    public string Message { get; set; }
}

public enum StepStatus
{
    Pending,
    Running,
    Completed,
    Failed
}
```

---

## å…­ã€å·¥ä½œæµç¨‹è®¾è®¡

### 6.1 æ•´ä½“æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
    â†“
[æ•°æ®éªŒè¯]
    â†“
[æ¨¡å—1: Divide] â†’ ç”Ÿæˆå¯å»ºè®¾åœŸåœ° (Suitable_Area.shp)
    â†“
[æ¨¡å—2: Distance]
    â”œâ”€ ğŸ”´ è®¡ç®—æ¬§æ°è·ç¦»(ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„è·ç¦»å‚æ•°) â†’ {æ•°æ®å}_distance.tif
    â”œâ”€ æ …æ ¼é‡åˆ†ç±» â†’ {æ•°æ®å}_reclassification.tif
    â””â”€ å¤„ç†NoData â†’ {æ•°æ®å}_reclassification_ND.tif
    â†“
[æ¨¡å—3: Rating]
    â”œâ”€ åŠ æƒæ±‚å’Œ â†’ {åŒºåŸŸå}_rating.tif
    â”œâ”€ è½¬çŸ¢é‡ â†’ {åŒºåŸŸå}_rating.shp
    â””â”€ ç›¸äº¤åˆ†æ â†’ Result_Rating_Suitable_Area.shp
    â†“
[æ¸…ç†ä¸´æ—¶æ–‡ä»¶]
    â†“
[åŠ è½½ç»“æœåˆ°åœ°å›¾]
    â†“
[åº”ç”¨ç¬¦å·ç³»ç»Ÿ]
    â†“
å®Œæˆ
```

### 6.2 æ ¸å¿ƒç®—æ³•æµç¨‹

#### 6.2.1 å¯å»ºè®¾åœŸåœ°åˆ’åˆ†æµç¨‹
```
1. åŠ è½½åˆ†æåŒºåŸŸè¦ç´ 
2. éå†æ‰€æœ‰çº¦æŸæ¡ä»¶æ•°æ®
3. å°†æ‰€æœ‰çº¦æŸæ¡ä»¶åˆå¹¶(Union)
4. æ‰§è¡Œåˆ†æåŒºåŸŸä¸çº¦æŸæ¡ä»¶çš„å·®é›†(Difference)
5. ä¿å­˜ç»“æœä¸º Suitable_Area.shp
```

#### 6.2.2 POIè·ç¦»è®¡ç®—æµç¨‹ âš ï¸ **ã€é‡ç‚¹ä¿®æ”¹ã€‘**

```
å¯¹äºæ¯ä¸ªPOIé¡¹:
    1. åˆ¤æ–­æ•°æ®ç±»å‹(çŸ¢é‡/æ …æ ¼)

    2. å¦‚æœæ˜¯çŸ¢é‡:
        a. ğŸ”´ ã€å…³é”®æ­¥éª¤ã€‘è·å–ç”¨æˆ·è¾“å…¥çš„"è·ç¦»"å­—æ®µå€¼,å–ç»å¯¹å€¼ä½œä¸ºmaxDistance
           - ä¾‹å¦‚: Distance = 500 â†’ maxDistance = 500ç±³
           - ä¾‹å¦‚: Distance = -800 â†’ maxDistance = 800ç±³

        b. ğŸ”´ ã€å…³é”®æ­¥éª¤ã€‘è°ƒç”¨æ¬§æ°è·ç¦»å·¥å…·,ä¼ å…¥maxDistanceå‚æ•°
           - ä½¿ç”¨ArcGIS Proçš„EuclideanDistanceå·¥å…·
           - è®¾ç½®maximum_distanceå‚æ•°ä¸ºmaxDistance
           - è®¡ç®—ç»“æœä¿å­˜ä¸º distance.tif

        c. ä½¿ç”¨distance.tifä½œä¸ºåç»­é‡åˆ†ç±»çš„è¾“å…¥

    3. å¦‚æœæ˜¯æ …æ ¼:
        a. ç›´æ¥ä½¿ç”¨åŸæ …æ ¼ä½œä¸ºè¾“å…¥
        b. è·³è¿‡æ¬§æ°è·ç¦»è®¡ç®—æ­¥éª¤

    4. æ‰§è¡Œé‡åˆ†ç±»:
        a. å¦‚æœä¸è‡ªå®šä¹‰é—´éš”: ä½¿ç”¨ç­‰é—´éš”åˆ†ç±»(10ç±»)
        b. å¦‚æœè‡ªå®šä¹‰é—´éš”: å¼¹çª—è®©ç”¨æˆ·è®¾ç½®
        c. æ ¹æ®è·ç¦»æ­£è´Ÿå†³å®šæ˜¯å¦åè½¬åˆ†ç±»å€¼:
           - Distance > 0 (ç§¯æè®¾æ–½): è·ç¦»è¶Šè¿‘åˆ†å€¼è¶Šé«˜ â†’ åè½¬åˆ†ç±»
           - Distance < 0 (åŒæ¶è®¾æ–½): è·ç¦»è¶Šè¿‘åˆ†å€¼è¶Šä½ â†’ ä¸åè½¬

    5. ä¿å­˜é‡åˆ†ç±»ç»“æœ â†’ reclassification.tif

    6. å¤„ç†NoDataå€¼:
        a. å¦‚æœDistance > 0: NoData â†’ 0 (è¶…å‡ºèŒƒå›´å¾—åˆ†æœ€ä½)
        b. å¦‚æœDistance < 0: NoData â†’ 10 (è¶…å‡ºèŒƒå›´å¾—åˆ†æœ€é«˜)

    7. ä¿å­˜æœ€ç»ˆç»“æœ â†’ reclassification_ND.tif
```

> **ğŸ”´ å…³é”®æ”¹è¿›è¯´æ˜**:
>
> **åŸæ–¹æ¡ˆé—®é¢˜**: æ¬§æ°è·ç¦»è®¡ç®—æœªæ˜ç¡®å¦‚ä½•è®¾ç½®æœ€å¤§è·ç¦»å‚æ•°,å®¹æ˜“å¯¼è‡´å¼€å‘æ—¶ä½¿ç”¨å›ºå®šå€¼(å¦‚1000ç±³)
>
> **æ–°æ–¹æ¡ˆè§£å†³**:
> 1. **æ˜ç¡®æ•°æ®æ¥æº**: ä»POIDataItem.Distanceå­—æ®µè·å–ç”¨æˆ·è¾“å…¥
> 2. **æ˜ç¡®è®¡ç®—æ–¹å¼**: å–Distanceçš„ç»å¯¹å€¼ä½œä¸ºæœ€å¤§è·ç¦»
> 3. **æ˜ç¡®ä¼ å‚æ–¹å¼**: å°†maxDistanceä¼ é€’ç»™EuclideanDistanceå·¥å…·
> 4. **ç¤ºä¾‹è¯´æ˜**: æä¾›æ­£è´Ÿè·ç¦»çš„å…·ä½“å¤„ç†ç¤ºä¾‹
>
> **å®ç°æ•ˆæœ**:
> - ç”¨æˆ·è¾“å…¥åŒ»é™¢è·ç¦»500ç±³ â†’ æ¬§æ°è·ç¦»è®¡ç®—èŒƒå›´0-500ç±³
> - ç”¨æˆ·è¾“å…¥åƒåœ¾åœºè·ç¦»-1000ç±³ â†’ æ¬§æ°è·ç¦»è®¡ç®—èŒƒå›´0-1000ç±³
> - å®ç°çµæ´»çš„ã€ç”¨æˆ·å¯æ§çš„è·ç¦»åˆ†æèŒƒå›´

#### 6.2.3 è¯„åˆ†è®¡ç®—æµç¨‹
```
1. æ„å»ºåŠ æƒæ±‚å’Œè¡¨è¾¾å¼:
    è¡¨è¾¾å¼ = (æ …æ ¼1 Ã— æƒé‡1) + (æ …æ ¼2 Ã— æƒé‡2) + ...
2. æ‰§è¡Œæ …æ ¼è®¡ç®— â†’ rating.tif
3. æ …æ ¼è½¬çŸ¢é‡(ç®€åŒ–é¢) â†’ rating.shp
4. ä¸å¯å»ºè®¾åœŸåœ°ç›¸äº¤ â†’ Result_Rating_Suitable_Area.shp
5. è¿”å›ç»“æœè·¯å¾„
```

---

## ä¸ƒã€æ¥å£äº¤äº’è®¾è®¡

### 7.1 ViewModel â†’ Services

**main_dockpaneViewModel.cs** ä¸­çš„ `RunAnalysis()` æ–¹æ³•è°ƒç”¨é¡ºåº:

```csharp
private async void RunAnalysis(object parameter)
{
    try
    {
        // 1. æ•°æ®éªŒè¯
        var validationResult = ValidationHelper.ValidateInputs(
            AnalysisAreaPath,
            ConstraintItems,
            POIItems,
            OutputPath);

        if (!validationResult.IsValid)
        {
            MessageBox.Show(validationResult.ErrorMessage);
            return;
        }

        // 2. åˆå§‹åŒ–ä¸´æ—¶æ–‡ä»¶ç®¡ç†å™¨
        var tempFileManager = new TempFileManager();

        // 3. æ‰§è¡Œæ¨¡å—1: åˆ’åˆ†å¯å»ºè®¾åœŸåœ°
        var divideService = new DivideService(tempFileManager);
        var suitableAreaPath = await divideService.ExecuteAsync(
            AnalysisAreaPath,
            ConstraintItems.Where(c => !c.IsEmpty).Select(c => c.DataPath).ToList(),
            tempFileManager.CreateTempFile("Suitable_Area.shp")
        );

        // 4. æ‰§è¡Œæ¨¡å—2: è·ç¦»è®¡ç®—
        var distanceService = new DistanceService(tempFileManager);
        var processedRasters = await distanceService.ExecuteAsync(
            POIItems.Where(p => !p.IsEmpty).ToList()
        );

        // 5. æ‰§è¡Œæ¨¡å—3: è¯„åˆ†è®¡ç®—
        var ratingService = new RatingService(tempFileManager);
        var weights = POIItems.Where(p => !p.IsEmpty)
            .ToDictionary(p => p.DataName, p => p.Weight.Value);
        var resultPath = await ratingService.ExecuteAsync(
            processedRasters,
            weights,
            suitableAreaPath,
            OutputPath
        );

        // 6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        tempFileManager.CleanupAll();

        // 7. åŠ è½½ç»“æœåˆ°åœ°å›¾
        var layerManager = new LayerManager();
        var layer = await layerManager.AddLayerToMap(resultPath);

        // 8. åº”ç”¨ç¬¦å·ç³»ç»Ÿ
        var symbologyManager = new SymbologyManager();
        await symbologyManager.ApplyGraduatedColors(layer, "gridcode");

        // 9. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        MessageBox.Show("é€‰å€åˆ†æå®Œæˆ!", "æˆåŠŸ");
    }
    catch (Exception ex)
    {
        LogService.LogError($"åˆ†æå¤±è´¥: {ex.Message}");
        MessageBox.Show($"åˆ†æå¤±è´¥: {ex.Message}", "é”™è¯¯");
    }
}
```

### 7.2 Serviceså†…éƒ¨åä½œ âš ï¸ **ã€åŒ…å«ä¿®æ”¹ç‚¹ã€‘**

**Distanceæ¨¡å—å†…éƒ¨åä½œç¤ºä¾‹:**

```
DistanceService.ExecuteAsync()
    â†“
å¯¹äºæ¯ä¸ªPOIé¡¹:
    â†“
    åˆ¤æ–­æ˜¯å¦ä¸ºçŸ¢é‡æ•°æ®
    â†“ (å¦‚æœæ˜¯çŸ¢é‡)
    ğŸ”´ EuclideanDistanceCalculator.CalculateAsync(
        inputPath: poiItem.DataPath,
        maxDistance: Math.Abs(poiItem.Distance.Value),  â† ã€ä½¿ç”¨ç”¨æˆ·è¾“å…¥è·ç¦»ã€‘
        outputPath: tempPath
    )
    â†“ è¿”å›è·ç¦»æ …æ ¼è·¯å¾„
    â†“
RasterReclassifier.ReclassifyAsync()
    â†“ è¿”å›é‡åˆ†ç±»æ …æ ¼è·¯å¾„
    â†“
NoDataHandler.ReplaceNoDataAsync()
    â†“ è¿”å›æœ€ç»ˆæ …æ ¼è·¯å¾„
```

**EuclideanDistanceCalculatorå®ç°ç¤ºä¾‹:**

```csharp
public async Task<string> CalculateAsync(string inputPath, double maxDistance, string outputPath)
{
    await QueuedTask.Run(() =>
    {
        var parameters = Geoprocessing.MakeValueArray(
            inputPath,           // in_source_data
            outputPath,          // out_distance_raster
            null,                // maximum_distance å‚æ•° â† ğŸ”´ ã€å…³é”®ã€‘
            null,                // cell_size
            null                 // distance_method
        );

        // ğŸ”´ ã€å…³é”®ä¿®æ”¹ã€‘è®¾ç½®æœ€å¤§è·ç¦»å‚æ•°
        if (maxDistance > 0)
        {
            parameters[2] = maxDistance;  // å°†ç”¨æˆ·è¾“å…¥çš„è·ç¦»ä½œä¸ºæœ€å¤§è·ç¦»
        }

        var result = Geoprocessing.ExecuteToolAsync(
            "sa.EuclideanDistance",
            parameters,
            null,
            null,
            null,
            GPExecuteToolFlags.Default
        ).Result;

        if (result.IsFailed)
        {
            throw new GeoprocessingException(
                $"æ¬§æ°è·ç¦»è®¡ç®—å¤±è´¥: {result.ErrorMessages}",
                "EuclideanDistance"
            );
        }
    });

    return outputPath;
}
```

---

## å…«ã€é…ç½®ç®¡ç†è®¾è®¡

### 8.1 Constants.cs - å¸¸é‡å®šä¹‰

```csharp
namespace HK_AREA_SEARCH.Common
{
    /// <summary>
    /// ç³»ç»Ÿå¸¸é‡
    /// </summary>
    public static class Constants
    {
        // æ–‡ä»¶åå¸¸é‡
        public const string SUITABLE_AREA_FILENAME = "Suitable_Area.shp";
        public const string RESULT_FILENAME = "Result_Rating_Suitable_Area.shp";

        // å­—æ®µåå¸¸é‡
        public const string RATING_FIELD = "gridcode";
        public const string VALUE_FIELD = "VALUE";

        // åˆ†ç±»å¸¸é‡
        public const int NUM_CLASSES = 10;
        public const string CLASSIFICATION_METHOD = "EQUAL_INTERVAL";

        // ğŸ”´ ã€æ–°å¢ã€‘è·ç¦»è®¡ç®—å¸¸é‡
        public const double DEFAULT_MAX_DISTANCE = 0;  // 0è¡¨ç¤ºä¸é™åˆ¶è·ç¦»
        public const string DISTANCE_UNIT = "ç±³";

        // ä¸´æ—¶æ–‡ä»¶å¤¹
        public const string TEMP_FOLDER_NAME = "HK_SEARCH_TEMP";

        // æ–‡ä»¶åç¼€
        public const string DISTANCE_SUFFIX = "_distance.tif";
        public const string RECLASS_SUFFIX = "_reclassification.tif";
        public const string NODATA_SUFFIX = "_reclassification_ND.tif";
        public const string RATING_SUFFIX = "_rating.tif";
    }
}
```

### 8.2 Enums.cs - æšä¸¾å®šä¹‰

```csharp
namespace HK_AREA_SEARCH.Common
{
    /// <summary>
    /// æ•°æ®ç±»å‹æšä¸¾
    /// </summary>
    public enum DataType
    {
        Vector,
        Raster,
        Unknown
    }

    /// <summary>
    /// åˆ†ç±»æ–¹æ³•æšä¸¾
    /// </summary>
    public enum ClassificationMethod
    {
        EqualInterval,
        Custom
    }

    /// <summary>
    /// å¤„ç†çŠ¶æ€æšä¸¾
    /// </summary>
    public enum ProcessStatus
    {
        NotStarted,
        InProgress,
        Completed,
        Failed
    }

    /// <summary>
    /// ğŸ”´ ã€æ–°å¢ã€‘POIç±»å‹æšä¸¾
    /// </summary>
    public enum POIType
    {
        Positive,   // ç§¯æè®¾æ–½(è·ç¦»ä¸ºæ­£)
        Negative    // åŒæ¶è®¾æ–½(è·ç¦»ä¸ºè´Ÿ)
    }
}
```

---

## ä¹ã€é”™è¯¯å¤„ç†ç­–ç•¥

### 9.1 å¼‚å¸¸å¤„ç†å±‚æ¬¡

```
1. UIå±‚ (ViewModel)
   - æ•è·æ‰€æœ‰å¼‚å¸¸
   - æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
   - è®°å½•æ—¥å¿—

2. ä¸šåŠ¡é€»è¾‘å±‚ (Services)
   - æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
   - æ‰§è¡Œäº‹åŠ¡å›æ»š
   - æ¸…ç†èµ„æº

3. åŸºç¡€è®¾æ–½å±‚ (Helpers)
   - æŠ›å‡ºæŠ€æœ¯å¼‚å¸¸
   - æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
```

### 9.2 è‡ªå®šä¹‰å¼‚å¸¸

```csharp
namespace HK_AREA_SEARCH.Exceptions
{
    /// <summary>
    /// åœ°ç†å¤„ç†å¼‚å¸¸
    /// </summary>
    public class GeoprocessingException : Exception
    {
        public string ToolName { get; set; }
        public Dictionary<string, object> Parameters { get; set; }

        public GeoprocessingException(string message, string toolName)
            : base(message)
        {
            ToolName = toolName;
        }
    }

    /// <summary>
    /// æ•°æ®éªŒè¯å¼‚å¸¸
    /// </summary>
    public class ValidationException : Exception
    {
        public string FieldName { get; set; }

        public ValidationException(string message, string fieldName)
            : base(message)
        {
            FieldName = fieldName;
        }
    }

    /// <summary>
    /// ğŸ”´ ã€æ–°å¢ã€‘è·ç¦»å‚æ•°å¼‚å¸¸
    /// </summary>
    public class DistanceParameterException : Exception
    {
        public string POIName { get; set; }
        public double? InputDistance { get; set; }

        public DistanceParameterException(string message, string poiName, double? distance)
            : base(message)
        {
            POIName = poiName;
            InputDistance = distance;
        }
    }
}
```

---

## åã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 10.1 å¼‚æ­¥å¤„ç†
- æ‰€æœ‰åœ°ç†å¤„ç†æ“ä½œä½¿ç”¨å¼‚æ­¥æ–¹æ³• (`async/await`)
- é¿å…é˜»å¡UIçº¿ç¨‹
- ä½¿ç”¨`QueuedTask.Run()`æ‰§è¡ŒArcGIS Proæ“ä½œ

### 10.2 èµ„æºç®¡ç†
- åŠæ—¶é‡Šæ”¾æ …æ ¼å’Œè¦ç´ ç±»èµ„æº
- ä½¿ç”¨`using`è¯­å¥ç®¡ç†IDisposableå¯¹è±¡
- ä¸´æ—¶æ–‡ä»¶åœ¨åˆ†æå®Œæˆåç«‹å³åˆ é™¤

### 10.3 ç¼“å­˜ç­–ç•¥
- ç¼“å­˜å¸¸ç”¨çš„GPå·¥å…·å‚æ•°
- ç¼“å­˜åœ°å›¾å’Œå›¾å±‚å¼•ç”¨
- é¿å…é‡å¤çš„å‡ ä½•è®¡ç®—

### 10.4 æ‰¹å¤„ç†ä¼˜åŒ–
- åˆå¹¶å¤šä¸ªçº¦æŸæ¡ä»¶æ—¶ä½¿ç”¨æ‰¹å¤„ç†
- æ …æ ¼è®¡ç®—æ—¶å°½é‡ä½¿ç”¨å•ä¸ªè¡¨è¾¾å¼å®Œæˆ

### 10.5 ğŸ”´ ã€æ–°å¢ã€‘è·ç¦»è®¡ç®—ä¼˜åŒ–
- æ ¹æ®ç”¨æˆ·è¾“å…¥çš„è·ç¦»å‚æ•°é™åˆ¶è®¡ç®—èŒƒå›´,é¿å…ä¸å¿…è¦çš„å…¨å±€è®¡ç®—
- å¯¹äºè¾ƒå°è·ç¦»å€¼(å¦‚<500ç±³),å¯æé«˜æ …æ ¼åˆ†è¾¨ç‡ä»¥è·å¾—æ›´ç²¾ç¡®ç»“æœ
- å¯¹äºè¾ƒå¤§è·ç¦»å€¼(å¦‚>5000ç±³),å¯é€‚å½“é™ä½åˆ†è¾¨ç‡ä»¥æå‡æ€§èƒ½

---

## åä¸€ã€æ‰©å±•æ€§è®¾è®¡

### 11.1 æ¥å£åŒ–è®¾è®¡
æ‰€æœ‰æ ¸å¿ƒæœåŠ¡å‡å®šä¹‰æ¥å£,ä¾¿äº:
- å•å…ƒæµ‹è¯•æ—¶Mockå®ç°
- æœªæ¥æ›¿æ¢å®ç°æ–¹å¼
- æ”¯æŒä¾èµ–æ³¨å…¥

### 11.2 æ’ä»¶åŒ–æ¶æ„
```
æœªæ¥å¯æ‰©å±•æ¨¡å—:
- Population/ (äººå£å¯†åº¦åˆ†ææ¨¡å—)
- Transportation/ (äº¤é€šä¾¿åˆ©æ€§åˆ†ææ¨¡å—)
- Environment/ (ç¯å¢ƒè´¨é‡åˆ†ææ¨¡å—)
- Report/ (æŠ¥å‘Šç”Ÿæˆæ¨¡å—)
```

### 11.3 é…ç½®åŒ–
- åˆ†ç±»æ•°é‡å¯é…ç½®(å½“å‰å›ºå®š10ç±»)
- è‰²å¸¦æ–¹æ¡ˆå¯é…ç½®
- ä¸´æ—¶æ–‡ä»¶è·¯å¾„å¯é…ç½®
- æ—¥å¿—çº§åˆ«å¯é…ç½®
- ğŸ”´ ã€æ–°å¢ã€‘é»˜è®¤æœ€å¤§è·ç¦»å¯é…ç½®

---

## åäºŒã€æµ‹è¯•ç­–ç•¥

### 12.1 å•å…ƒæµ‹è¯•
- Models: æµ‹è¯•æ•°æ®æ¨¡å‹å±æ€§å˜åŒ–å’ŒéªŒè¯é€»è¾‘
- Helpers: æµ‹è¯•è¾…åŠ©æ–¹æ³•çš„è¾¹ç•Œæ¡ä»¶
- Services: ä½¿ç”¨Mockæµ‹è¯•ä¸šåŠ¡é€»è¾‘

### 12.2 é›†æˆæµ‹è¯•
- æµ‹è¯•Divide â†’ Distance â†’ Ratingå®Œæ•´æµç¨‹
- æµ‹è¯•ä¸´æ—¶æ–‡ä»¶åˆ›å»ºå’Œæ¸…ç†
- æµ‹è¯•å›¾å±‚åŠ è½½å’Œç¬¦å·åŒ–
- ğŸ”´ ã€æ–°å¢ã€‘æµ‹è¯•ä¸åŒè·ç¦»å‚æ•°ä¸‹çš„æ¬§æ°è·ç¦»è®¡ç®—ç»“æœ

### 12.3 UIæµ‹è¯•
- æµ‹è¯•æ•°æ®è¾“å…¥éªŒè¯
- æµ‹è¯•æƒé‡å’ŒéªŒè¯
- æµ‹è¯•åŠ¨æ€ç©ºè¡Œç®¡ç†
- ğŸ”´ ã€æ–°å¢ã€‘æµ‹è¯•è·ç¦»å‚æ•°è¾“å…¥å’ŒéªŒè¯

### 12.4 ğŸ”´ ã€æ–°å¢ã€‘è·ç¦»è®¡ç®—ä¸“é¡¹æµ‹è¯•
```
æµ‹è¯•ç”¨ä¾‹:
1. æ­£è·ç¦»å€¼(å¦‚500ç±³)çš„æ¬§æ°è·ç¦»è®¡ç®—
2. è´Ÿè·ç¦»å€¼(å¦‚-1000ç±³)çš„æ¬§æ°è·ç¦»è®¡ç®—
3. é›¶è·ç¦»å€¼çš„å¤„ç†(åº”æŠ¥é”™æˆ–ä½¿ç”¨é»˜è®¤å€¼)
4. è¶…å¤§è·ç¦»å€¼(å¦‚>10000ç±³)çš„æ€§èƒ½æµ‹è¯•
5. å¤šä¸ªä¸åŒè·ç¦»POIçš„æ‰¹é‡è®¡ç®—
```

---

## åä¸‰ã€éƒ¨ç½²ç»“æ„

### 13.1 ç¼–è¯‘è¾“å‡º
```
bin/Debug/
â”œâ”€â”€ HK_AREA_SEARCH.dll          # ä¸»ç¨‹åºé›†
â”œâ”€â”€ Config.daml                  # é…ç½®æ–‡ä»¶
â”œâ”€â”€ Images/                      # å›¾æ ‡èµ„æº
â””â”€â”€ DarkImages/                  # æš—è‰²ä¸»é¢˜å›¾æ ‡
```

### 13.2 ArcGIS ProåŠ è½½
- ç¼–è¯‘åè‡ªåŠ¨å¤åˆ¶åˆ°ArcGIS Pro Add-insç›®å½•
- é€šè¿‡Config.damlæ³¨å†ŒDockpaneå’ŒæŒ‰é’®
- Module1.csä½œä¸ºæ’ä»¶å…¥å£ç‚¹

---

## åå››ã€å¼€å‘ä¼˜å…ˆçº§

### é˜¶æ®µ1: æ ¸å¿ƒåŠŸèƒ½å®ç°(é«˜ä¼˜å…ˆçº§)
1. å®Œå–„Modelså±‚(å·²åŸºæœ¬å®Œæˆ)
2. å®ç°Divideæ¨¡å—
3. ğŸ”´ **å®ç°Distanceæ¨¡å—(é‡ç‚¹å…³æ³¨æ¬§æ°è·ç¦»å‚æ•°ä¼ é€’)**
4. å®ç°Ratingæ¨¡å—

### é˜¶æ®µ2: åŸºç¡€è®¾æ–½å®Œå–„(ä¸­ä¼˜å…ˆçº§)
1. TempFileManagerå®ç°
2. GeoprocessingHelperå®ç°
3. LayerManagerå®ç°
4. SymbologyManagerå®ç°

### é˜¶æ®µ3: å¢å¼ºåŠŸèƒ½(ä½ä¼˜å…ˆçº§)
1. LogServiceå®ç°
2. è¿›åº¦æ¡æ˜¾ç¤º
3. é”™è¯¯è¯¦ç»†æŠ¥å‘Š
4. ç»“æœé¢„è§ˆåŠŸèƒ½

---

## åäº”ã€æŠ€æœ¯è¦ç‚¹

### 15.1 ArcGIS Pro SDKå…³é”®API

**åœ°ç†å¤„ç†å·¥å…·è°ƒç”¨:**
```csharp
using ArcGIS.Desktop.GeoProcessing;

// å¼‚æ­¥æ‰§è¡ŒGPå·¥å…·
var parameters = Geoprocessing.MakeValueArray(input1, input2, output);
var result = await Geoprocessing.ExecuteToolAsync(
    "analysis.Intersect",
    parameters);
```

**ğŸ”´ ã€é‡ç‚¹ã€‘æ¬§æ°è·ç¦»å·¥å…·è°ƒç”¨ç¤ºä¾‹:**
```csharp
using ArcGIS.Desktop.GeoProcessing;

/// <summary>
/// è®¡ç®—æ¬§æ°è·ç¦»(æ ¹æ®ç”¨æˆ·è¾“å…¥çš„è·ç¦»å‚æ•°)
/// </summary>
public async Task<string> CalculateEuclideanDistance(
    string inputFeatures,      // è¾“å…¥è¦ç´ 
    double maxDistance,        // ğŸ”´ æœ€å¤§è·ç¦»(ä»POIDataItem.Distanceè·å–)
    string outputRaster)       // è¾“å‡ºæ …æ ¼
{
    await QueuedTask.Run(async () =>
    {
        // æ„å»ºå‚æ•°æ•°ç»„
        var parameters = Geoprocessing.MakeValueArray(
            inputFeatures,           // in_source_data
            outputRaster,            // out_distance_raster
            maxDistance,             // ğŸ”´ maximum_distance (å…³é”®å‚æ•°)
            null,                    // cell_size
            null                     // distance_method (é»˜è®¤PLANAR)
        );

        // æ‰§è¡Œæ¬§æ°è·ç¦»å·¥å…·
        var gpResult = await Geoprocessing.ExecuteToolAsync(
            "sa.EuclideanDistance",  // Spatial Analystæ‰©å±•çš„æ¬§æ°è·ç¦»å·¥å…·
            parameters,
            null,
            null,
            null,
            GPExecuteToolFlags.Default
        );

        // æ£€æŸ¥æ‰§è¡Œç»“æœ
        if (gpResult.IsFailed)
        {
            var errorMsg = string.Join("\n", gpResult.ErrorMessages);
            throw new GeoprocessingException(
                $"æ¬§æ°è·ç¦»è®¡ç®—å¤±è´¥: {errorMsg}",
                "EuclideanDistance"
            );
        }
    });

    return outputRaster;
}

// ğŸ”´ è°ƒç”¨ç¤ºä¾‹
public async Task ProcessPOI(POIDataItem poiItem)
{
    if (!poiItem.IsRasterData && poiItem.Distance.HasValue)
    {
        // è·å–ç”¨æˆ·è¾“å…¥çš„è·ç¦»,å–ç»å¯¹å€¼
        double maxDist = Math.Abs(poiItem.Distance.Value);

        // ç”Ÿæˆè¾“å‡ºè·¯å¾„
        string outputPath = $"{tempFolder}\\{poiItem.DataName}_distance.tif";

        // ğŸ”´ è°ƒç”¨æ¬§æ°è·ç¦»è®¡ç®—,ä¼ å…¥ç”¨æˆ·æŒ‡å®šçš„è·ç¦»
        await CalculateEuclideanDistance(
            poiItem.DataPath,
            maxDist,           // ğŸ”´ ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„è·ç¦»
            outputPath
        );
    }
}
```

**æ …æ ¼æ“ä½œ:**
```csharp
using ArcGIS.Core.Data.Raster;
using ArcGIS.Desktop.Core;

await QueuedTask.Run(() =>
{
    using (Raster raster = RasterDatasetExtensions.OpenRaster(rasterPath))
    {
        // æ …æ ¼æ“ä½œ
    }
});
```

**å›¾å±‚ç®¡ç†:**
```csharp
using ArcGIS.Desktop.Mapping;

await QueuedTask.Run(() =>
{
    var map = MapView.Active.Map;
    LayerFactory.Instance.CreateLayer(
        new Uri(featureClassPath),
        map);
});
```

### 15.2 MVVMæ¨¡å¼å®ç°è¦ç‚¹

- ViewModelç»§æ‰¿`DockPane`æˆ–`PropertyChangedBase`
- ä½¿ç”¨`SetProperty()`è§¦å‘å±æ€§å˜åŒ–é€šçŸ¥
- å‘½ä»¤ä½¿ç”¨`RelayCommand`æˆ–`ICommand`å®ç°
- æ•°æ®ç»‘å®šé€šè¿‡XAMLçš„`{Binding}`è¯­æ³•

### 15.3 å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼

```csharp
// ArcGIS Proæ“ä½œå¿…é¡»åœ¨QueuedTaskä¸­æ‰§è¡Œ
await QueuedTask.Run(() =>
{
    // æ‰§è¡Œåœ°ç†å¤„ç†æ“ä½œ
});

// é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ä½¿ç”¨ProgressDialog
var pd = new ProgressDialog("æ­£åœ¨å¤„ç†...");
pd.Show();
try
{
    await Task.Run(() =>
    {
        // é•¿æ—¶é—´ä»»åŠ¡
    });
}
finally
{
    pd.Hide();
}
```

---

## åå…­ã€ç‰ˆæœ¬å¯¹æ¯”ä¸ä¿®æ”¹æ€»ç»“

### 16.1 v2.0ä¸»è¦ä¿®æ”¹ç‚¹

| ä¿®æ”¹ä½ç½® | åŸç‰ˆæœ¬é—®é¢˜ | v2.0æ”¹è¿› |
|---------|-----------|----------|
| **3.2.2èŠ‚ - EuclideanDistanceCalculator** | æœªæ˜ç¡®å¦‚ä½•è®¾ç½®æœ€å¤§è·ç¦»å‚æ•° | ğŸ”´ æ˜ç¡®è¦æ±‚ä»POIDataItem.Distanceå­—æ®µè·å–å¹¶å–ç»å¯¹å€¼ |
| **6.2.2èŠ‚ - POIè·ç¦»è®¡ç®—æµç¨‹** | æœªè¯´æ˜è·ç¦»å‚æ•°çš„ä½¿ç”¨æ–¹å¼ | ğŸ”´ è¯¦ç»†è¯´æ˜è·ç¦»å‚æ•°çš„è·å–ã€å¤„ç†å’Œä¼ é€’æµç¨‹ |
| **7.2èŠ‚ - Serviceså†…éƒ¨åä½œ** | æœªå±•ç¤ºè·ç¦»å‚æ•°ä¼ é€’ | ğŸ”´ å¢åŠ EuclideanDistanceCalculatorå®ç°ç¤ºä¾‹ |
| **8.1èŠ‚ - Constants.cs** | æ— è·ç¦»ç›¸å…³å¸¸é‡ | ğŸ”´ æ–°å¢DEFAULT_MAX_DISTANCEå’ŒDISTANCE_UNITå¸¸é‡ |
| **9.2èŠ‚ - è‡ªå®šä¹‰å¼‚å¸¸** | æ— è·ç¦»å‚æ•°å¼‚å¸¸ | ğŸ”´ æ–°å¢DistanceParameterExceptionç±» |
| **10.5èŠ‚ - æ€§èƒ½ä¼˜åŒ–** | æ— è·ç¦»ç›¸å…³ä¼˜åŒ– | ğŸ”´ æ–°å¢è·ç¦»è®¡ç®—ä¼˜åŒ–ç­–ç•¥ |
| **12.4èŠ‚ - æµ‹è¯•ç­–ç•¥** | æ— è·ç¦»è®¡ç®—æµ‹è¯• | ğŸ”´ æ–°å¢è·ç¦»è®¡ç®—ä¸“é¡¹æµ‹è¯•ç”¨ä¾‹ |
| **15.1èŠ‚ - æŠ€æœ¯è¦ç‚¹** | æ— æ¬§æ°è·ç¦»è°ƒç”¨ç¤ºä¾‹ | ğŸ”´ æ–°å¢è¯¦ç»†çš„æ¬§æ°è·ç¦»APIè°ƒç”¨ç¤ºä¾‹ |

### 16.2 å…³é”®æ”¹è¿›è¯´æ˜

#### ğŸ”´ æ ¸å¿ƒæ”¹è¿›: æ¬§æ°è·ç¦»å‚æ•°åŠ¨æ€åŒ–

**æ”¹è¿›å‰:**
```
è®¡ç®—æ¬§æ°è·ç¦» â†’ æœªæ˜ç¡®æœ€å¤§è·ç¦»å¦‚ä½•è®¾ç½® â†’ å¯èƒ½ä½¿ç”¨å›ºå®šå€¼1000ç±³
```

**æ”¹è¿›å:**
```
è·å–POIDataItem.Distance â†’ å–ç»å¯¹å€¼ â†’ ä¼ é€’ç»™EuclideanDistanceå·¥å…· â†’ ç²¾ç¡®æ§åˆ¶è®¡ç®—èŒƒå›´
```

**å®ç°æ•ˆæœå¯¹æ¯”:**

| åœºæ™¯ | åŸæ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ |
|-----|-------|-------|
| è¯Šæ‰€(500ç±³) | è®¡ç®—0-1000ç±³(æµªè´¹) | è®¡ç®—0-500ç±³(ç²¾ç¡®) |
| åœ°é“ç«™(300ç±³) | è®¡ç®—0-1000ç±³(æµªè´¹) | è®¡ç®—0-300ç±³(ç²¾ç¡®) |
| åƒåœ¾åœº(-2000ç±³) | è®¡ç®—0-1000ç±³(ä¸è¶³) | è®¡ç®—0-2000ç±³(å®Œæ•´) |

**ç”¨æˆ·ä½“éªŒæå‡:**
1. âœ… çµæ´»æ€§: ç”¨æˆ·å¯è‡ªä¸»æ§åˆ¶æ¯ä¸ªPOIçš„åˆ†æèŒƒå›´
2. âœ… ç²¾ç¡®æ€§: é¿å…è¶…å‡ºéœ€æ±‚èŒƒå›´çš„è®¡ç®—
3. âœ… æ€§èƒ½: å°èŒƒå›´è®¡ç®—æ›´å¿«,å¤§èŒƒå›´è®¡ç®—æ›´å®Œæ•´
4. âœ… å¯ç†è§£æ€§: è¾“å…¥çš„è·ç¦»ç›´æ¥å½±å“åˆ†æç»“æœ

---

## åä¸ƒã€æ€»ç»“

æœ¬æ¶æ„è®¾è®¡æ–¹æ¡ˆ(v2.0)éµå¾ªä»¥ä¸‹åŸåˆ™:

1. **æ¨¡å—åŒ–**: æŒ‰ç…§åŠŸèƒ½éœ€æ±‚åˆ’åˆ†ä¸ºDivideã€Distanceã€Ratingä¸‰å¤§æ¨¡å—
2. **åˆ†å±‚æ¶æ„**: UIå±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€åŸºç¡€è®¾æ–½å±‚æ¸…æ™°åˆ†ç¦»
3. **æ¥å£å¯¼å‘**: æ ¸å¿ƒæœåŠ¡å‡å®šä¹‰æ¥å£,ä¾¿äºæµ‹è¯•å’Œæ‰©å±•
4. **MVVMæ¨¡å¼**: UIä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»,ç¬¦åˆWPFæœ€ä½³å®è·µ
5. **å¼‚æ­¥ä¼˜å…ˆ**: æ‰€æœ‰è€—æ—¶æ“ä½œä½¿ç”¨å¼‚æ­¥æ–¹æ³•,ä¿è¯UIå“åº”æ€§
6. **èµ„æºç®¡ç†**: ç»Ÿä¸€ç®¡ç†ä¸´æ—¶æ–‡ä»¶,ç¡®ä¿èµ„æºåŠæ—¶é‡Šæ”¾
7. **å¯æ‰©å±•æ€§**: é¢„ç•™æ‰©å±•æ¥å£,æ”¯æŒæœªæ¥åŠŸèƒ½å¢åŠ 
8. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶,æä¾›å‹å¥½çš„é”™è¯¯æç¤º
9. ğŸ”´ **å‚æ•°åŒ–**: å…³é”®è®¡ç®—å‚æ•°(å¦‚æ¬§æ°è·ç¦»)ç”±ç”¨æˆ·è¾“å…¥é©±åŠ¨,æå‡çµæ´»æ€§

### v2.0ç‰ˆæœ¬æ ¸å¿ƒä»·å€¼

âœ… **è§£å†³äº†åŸæ–¹æ¡ˆçš„å…³é”®ç¼ºé™·**: æ˜ç¡®äº†æ¬§æ°è·ç¦»è®¡ç®—çš„å‚æ•°æ¥æºå’Œä¼ é€’æ–¹å¼

âœ… **æä¾›äº†å®Œæ•´çš„å®ç°æŒ‡å¯¼**: åŒ…å«è¯¦ç»†çš„ä»£ç ç¤ºä¾‹å’Œè°ƒç”¨æµç¨‹

âœ… **å¢å¼ºäº†ç³»ç»Ÿçš„å¯ç”¨æ€§**: ç”¨æˆ·å¯ç²¾ç¡®æ§åˆ¶æ¯ä¸ªPOIçš„åˆ†æèŒƒå›´

âœ… **ä¿æŒäº†æ¶æ„çš„å®Œæ•´æ€§**: åœ¨åŸæœ‰è‰¯å¥½æ¶æ„åŸºç¡€ä¸Šè¿›è¡Œé’ˆå¯¹æ€§æ”¹è¿›

é€šè¿‡æœ¬æ¶æ„è®¾è®¡æ–¹æ¡ˆv2.0,å¯ä»¥å®ç°ä¸€ä¸ª**ç»“æ„æ¸…æ™°ã€æ˜“äºç»´æŠ¤ã€åŠŸèƒ½å®Œå–„ã€å‚æ•°çµæ´»**çš„ArcGIS Proé€‰å€åˆ†ææ’ä»¶ã€‚

---

## é™„å½•: å¿«é€Ÿæ£€ç´¢

### å…³é”®ä¿®æ”¹ç‚¹å¿«é€Ÿå®šä½

1. **æ¬§æ°è·ç¦»è®¡ç®—å™¨è®¾è®¡** â†’ ç¬¬3.2.2èŠ‚
2. **POIè·ç¦»è®¡ç®—æµç¨‹** â†’ ç¬¬6.2.2èŠ‚
3. **Serviceså†…éƒ¨åä½œ** â†’ ç¬¬7.2èŠ‚
4. **æ¬§æ°è·ç¦»APIè°ƒç”¨** â†’ ç¬¬15.1èŠ‚
5. **ç‰ˆæœ¬å¯¹æ¯”è¯´æ˜** â†’ ç¬¬16èŠ‚

### å¼€å‘æ£€æŸ¥æ¸…å•

åœ¨å®ç°Distanceæ¨¡å—æ—¶,è¯·ç¡®ä¿:

- [ ] POIDataItem.Distanceå­—æ®µå·²æ­£ç¡®è·å–
- [ ] Distanceå€¼å·²å–ç»å¯¹å€¼ä½œä¸ºmaxDistance
- [ ] maxDistanceå·²ä¼ é€’ç»™EuclideanDistanceå·¥å…·çš„maximum_distanceå‚æ•°
- [ ] å·²å¤„ç†Distanceä¸ºnullæˆ–0çš„è¾¹ç•Œæƒ…å†µ
- [ ] å·²æ·»åŠ è·ç¦»å‚æ•°ç›¸å…³çš„å¼‚å¸¸å¤„ç†
- [ ] å·²ç¼–å†™è·ç¦»è®¡ç®—çš„å•å…ƒæµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¥æœŸ**: 2025
**æœ€åæ›´æ–°**: 2025
**ä¿®è®¢è¯´æ˜**: é’ˆå¯¹æ¬§æ°è·ç¦»å‚æ•°è®¾ç½®è¿›è¡Œé‡ç‚¹ä¿®æ­£å’Œæ ‡æ³¨
