# 香港适宜建设土地选址工具 - 界面代码设计方案

## 一、整体架构

本方案采用 **MVVM (Model-View-ViewModel)** 架构模式，基于 ArcGIS Pro SDK for .NET 进行开发。

### 1.1 核心文件结构

```
HK_AREA_SEARCH/
├── Views/
│   ├── main_dockpane.xaml                     // 主界面XAML
│   └── CustomIntervalDialog.xaml              // 自定义距离间隔对话框
├── ViewModels/
│   ├── main_dockpaneViewModel.cs              // 主界面ViewModel
│   └── CustomIntervalDialogViewModel.cs       // 对话框ViewModel
├── Models/
│   ├── ConstraintDataItem.cs                  // 约束条件数据项模型
│   ├── POIDataItem.cs                         // POI数据项模型
│   └── IntervalClassItem.cs                   // 分类间隔项模型
├── Controls/
│   ├── FilePathTextBox.xaml                   // 文件路径输入控件
│   └── DataGridRowWithValidation.cs           // 带验证的数据网格行
├── Converters/
│   ├── BooleanToYesNoConverter.cs             // 布尔值转"是/否"转换器
│   └── WeightSumValidationConverter.cs        // 权重和验证转换器
└── Helpers/
    └── DragDropHelper.cs                      // 拖放辅助类
```

---

## 二、数据模型设计

### 2.1 约束条件数据项 (ConstraintDataItem.cs)

```csharp
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace HK_AREA_SEARCH.Models
{
    /// <summary>
    /// 约束条件数据项模型
    /// </summary>
    public class ConstraintDataItem : INotifyPropertyChanged
    {
        private string _dataPath;
        private string _dataName;

        /// <summary>
        /// 数据文件路径
        /// </summary>
        public string DataPath
        {
            get => _dataPath;
            set
            {
                if (_dataPath != value)
                {
                    _dataPath = value;
                    OnPropertyChanged();
                    // 自动提取文件名
                    DataName = System.IO.Path.GetFileNameWithoutExtension(value);
                }
            }
        }

        /// <summary>
        /// 数据名称（显示用）
        /// </summary>
        public string DataName
        {
            get => _dataName;
            set
            {
                if (_dataName != value)
                {
                    _dataName = value;
                    OnPropertyChanged();
                }
            }
        }

        /// <summary>
        /// 是否为空白行
        /// </summary>
        public bool IsEmpty => string.IsNullOrWhiteSpace(DataPath);

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}
```

### 2.2 POI数据项 (POIDataItem.cs)

```csharp
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace HK_AREA_SEARCH.Models
{
    /// <summary>
    /// POI数据项模型
    /// </summary>
    public class POIDataItem : INotifyPropertyChanged
    {
        private string _dataPath;
        private string _dataName;
        private int? _distance;
        private double? _weight;
        private bool _customInterval;
        private bool _isRasterData;

        /// <summary>
        /// 输入数据路径
        /// </summary>
        public string DataPath
        {
            get => _dataPath;
            set
            {
                if (_dataPath != value)
                {
                    _dataPath = value;
                    OnPropertyChanged();
                    DataName = System.IO.Path.GetFileNameWithoutExtension(value);

                    // 判断是否为栅格数据
                    var ext = System.IO.Path.GetExtension(value)?.ToLower();
                    IsRasterData = ext == ".tif" || ext == ".tiff" || ext == ".img";
                }
            }
        }

        /// <summary>
        /// 数据名称
        /// </summary>
        public string DataName
        {
            get => _dataName;
            set
            {
                if (_dataName != value)
                {
                    _dataName = value;
                    OnPropertyChanged();
                }
            }
        }

        /// <summary>
        /// 距离（米），正数或负数
        /// </summary>
        public int? Distance
        {
            get => _distance;
            set
            {
                // 如果是栅格数据，强制为空
                if (IsRasterData)
                {
                    _distance = null;
                }
                else
                {
                    _distance = value;
                }
                OnPropertyChanged();
            }
        }

        /// <summary>
        /// 权重（小于1.0的浮点数，保留两位小数）
        /// </summary>
        public double? Weight
        {
            get => _weight;
            set
            {
                if (value.HasValue)
                {
                    _weight = Math.Round(value.Value, 2);
                }
                else
                {
                    _weight = value;
                }
                OnPropertyChanged();
            }
        }

        /// <summary>
        /// 是否自定义距离间隔
        /// </summary>
        public bool CustomInterval
        {
            get => _customInterval;
            set
            {
                if (_customInterval != value)
                {
                    _customInterval = value;
                    OnPropertyChanged();
                }
            }
        }

        /// <summary>
        /// 是否为栅格数据
        /// </summary>
        public bool IsRasterData
        {
            get => _isRasterData;
            private set
            {
                if (_isRasterData != value)
                {
                    _isRasterData = value;
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsDistanceEnabled));

                    // 如果是栅格数据，清空距离
                    if (_isRasterData)
                    {
                        Distance = null;
                    }
                }
            }
        }

        /// <summary>
        /// 距离字段是否可编辑
        /// </summary>
        public bool IsDistanceEnabled => !IsRasterData;

        /// <summary>
        /// 是否为空白行
        /// </summary>
        public bool IsEmpty => string.IsNullOrWhiteSpace(DataPath);

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}
```

### 2.3 分类间隔项 (IntervalClassItem.cs)

```csharp
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace HK_AREA_SEARCH.Models
{
    /// <summary>
    /// 分类间隔项模型（用于自定义距离间隔对话框）
    /// </summary>
    public class IntervalClassItem : INotifyPropertyChanged
    {
        private double _startValue;
        private double _endValue;
        private int _classValue;

        /// <summary>
        /// 开始值
        /// </summary>
        public double StartValue
        {
            get => _startValue;
            set
            {
                if (_startValue != value)
                {
                    _startValue = value;
                    OnPropertyChanged();
                }
            }
        }

        /// <summary>
        /// 结束值
        /// </summary>
        public double EndValue
        {
            get => _endValue;
            set
            {
                if (_endValue != value)
                {
                    _endValue = value;
                    OnPropertyChanged();
                }
            }
        }

        /// <summary>
        /// 类别值（0-10或10-0）
        /// </summary>
        public int ClassValue
        {
            get => _classValue;
            set
            {
                if (_classValue != value)
                {
                    _classValue = value;
                    OnPropertyChanged();
                }
            }
        }

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}
```

---

## 三、主界面XAML设计 (main_dockpane.xaml)

```xaml
<UserControl x:Class="HK_AREA_SEARCH.main_dockpaneView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="clr-namespace:HK_AREA_SEARCH"
             xmlns:extensions="clr-namespace:ArcGIS.Desktop.Extensions;assembly=ArcGIS.Desktop.Extensions"
             xmlns:converters="clr-namespace:HK_AREA_SEARCH.Converters"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="850"
             d:DataContext="{Binding Path=ui.main_dockpaneViewModel}"
             AllowDrop="True">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <extensions:DesignOnlyResourceDictionary Source="pack://application:,,,/ArcGIS.Desktop.Framework;component\Themes\Default.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- 转换器 -->
            <converters:BooleanToYesNoConverter x:Key="BoolToYesNoConverter"/>

            <!-- 样式定义 -->
            <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="FontWeight" Value="Bold"/>
                <Setter Property="Margin" Value="0,10,0,5"/>
            </Style>

            <Style x:Key="FolderButtonStyle" TargetType="Button">
                <Setter Property="Width" Value="30"/>
                <Setter Property="Height" Value="25"/>
                <Setter Property="Margin" Value="5,0,0,0"/>
                <Setter Property="Content" Value="📁"/>
                <Setter Property="FontSize" Value="14"/>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 标题 -->
        <TextBlock Grid.Row="0"
                   Text="香港选址工具"
                   Style="{DynamicResource Esri_TextBlockDockPaneHeader}"
                   FontSize="18"
                   HorizontalAlignment="Center"
                   Margin="0,0,0,10"/>

        <!-- 主内容区域 -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <!-- 1. 约束条件部分 -->
                <TextBlock Text="约束条件" Style="{StaticResource SectionHeaderStyle}"/>
                <Border BorderBrush="Gray" BorderThickness="1" Padding="10" Margin="0,5,0,10">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- 标题行 -->
                        <Grid Grid.Row="0" Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="40"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="输入要素" FontWeight="Bold" VerticalAlignment="Center"/>
                        </Grid>

                        <!-- 约束条件列表 -->
                        <ItemsControl Grid.Row="1" ItemsSource="{Binding ConstraintItems}" MaxHeight="200">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="40"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- 下拉图标（装饰用） -->
                                        <TextBlock Grid.Column="0" Text="▼" VerticalAlignment="Center" Margin="5,0"/>

                                        <!-- 数据名称显示 -->
                                        <TextBox Grid.Column="1"
                                                 Text="{Binding DataName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                 IsReadOnly="True"
                                                 Background="White"
                                                 VerticalContentAlignment="Center"
                                                 AllowDrop="True"
                                                 PreviewDragOver="ConstraintItem_PreviewDragOver"
                                                 Drop="ConstraintItem_Drop"
                                                 Margin="2,0"/>

                                        <!-- 文件夹按钮 -->
                                        <Button Grid.Column="2"
                                                Style="{StaticResource FolderButtonStyle}"
                                                Command="{Binding DataContext.BrowseConstraintCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"/>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>

                <!-- 2. 地区部分 -->
                <TextBlock Text="地区" Style="{StaticResource SectionHeaderStyle}"/>
                <Border BorderBrush="Gray" BorderThickness="1" Padding="10" Margin="0,5,0,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="分析区域" VerticalAlignment="Center" Margin="5,0"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding AnalysisAreaPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 VerticalContentAlignment="Center"
                                 Margin="5,0"
                                 AllowDrop="True"
                                 PreviewDragOver="AnalysisArea_PreviewDragOver"
                                 Drop="AnalysisArea_Drop"/>
                        <Button Grid.Column="2"
                                Style="{StaticResource FolderButtonStyle}"
                                Command="{Binding BrowseAnalysisAreaCommand}"/>
                    </Grid>
                </Border>

                <!-- 3. POI部分 -->
                <TextBlock Text="POI" Style="{StaticResource SectionHeaderStyle}"/>
                <Border BorderBrush="Gray" BorderThickness="1" Padding="10" Margin="0,5,0,10">
                    <DataGrid ItemsSource="{Binding POIItems}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="True"
                              CanUserReorderColumns="False"
                              CanUserSortColumns="False"
                              HeadersVisibility="Column"
                              GridLinesVisibility="All"
                              MaxHeight="250"
                              VerticalScrollBarVisibility="Auto">

                        <DataGrid.Columns>
                            <!-- 输入数据列 -->
                            <DataGridTemplateColumn Header="输入数据" Width="2*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="30"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBox Grid.Column="0"
                                                     Text="{Binding DataName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                     IsReadOnly="True"
                                                     VerticalContentAlignment="Center"
                                                     AllowDrop="True"
                                                     PreviewDragOver="POIItem_PreviewDragOver"
                                                     Drop="POIItem_Drop"/>

                                            <Button Grid.Column="1"
                                                    Content="📁"
                                                    FontSize="12"
                                                    Width="25"
                                                    Height="22"
                                                    Command="{Binding DataContext.BrowsePOICommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"/>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- 距离列 -->
                            <DataGridTemplateColumn Header="距离" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding Distance, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                 IsEnabled="{Binding IsDistanceEnabled}"
                                                 VerticalContentAlignment="Center"
                                                 HorizontalContentAlignment="Right"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- 权重列 -->
                            <DataGridTemplateColumn Header="权重" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding Weight, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}"
                                                 VerticalContentAlignment="Center"
                                                 HorizontalContentAlignment="Right"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- 自定义距离间隔列 -->
                            <DataGridTemplateColumn Header="自定义距离间隔" Width="1.5*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox SelectedValue="{Binding CustomInterval, Mode=TwoWay}"
                                                  VerticalContentAlignment="Center">
                                            <ComboBoxItem Content="是" Tag="True"/>
                                            <ComboBoxItem Content="否" Tag="False" IsSelected="True"/>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>

                <!-- 权重验证提示 -->
                <TextBlock Text="{Binding WeightSumValidationMessage}"
                           Foreground="Red"
                           FontSize="12"
                           Margin="0,0,0,10"
                           Visibility="{Binding IsWeightSumValid, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                <!-- 4. 输出部分 -->
                <TextBlock Text="输出" Style="{StaticResource SectionHeaderStyle}"/>
                <Border BorderBrush="Gray" BorderThickness="1" Padding="10" Margin="0,5,0,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="输出要素" VerticalAlignment="Center" Margin="5,0"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding OutputPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 VerticalContentAlignment="Center"
                                 Margin="5,0"/>
                        <Button Grid.Column="2"
                                Style="{StaticResource FolderButtonStyle}"
                                Command="{Binding BrowseOutputCommand}"/>
                    </Grid>
                </Border>

                <!-- 5. 运行按钮 -->
                <Button Content="▶ 运行"
                        HorizontalAlignment="Right"
                        Width="100"
                        Height="35"
                        FontSize="14"
                        Margin="0,10,0,0"
                        Command="{Binding RunAnalysisCommand}"
                        Style="{DynamicResource Esri_Button}"/>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
```

---

## 四、主界面ViewModel设计 (main_dockpaneViewModel.cs)

```csharp
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows.Input;
using ArcGIS.Desktop.Framework;
using ArcGIS.Desktop.Framework.Contracts;
using ArcGIS.Desktop.Framework.Dialogs;
using HK_AREA_SEARCH.Models;

namespace HK_AREA_SEARCH
{
    internal class main_dockpaneViewModel : DockPane
    {
        private const string _dockPaneID = "HK_AREA_SEARCH_main_dockpane";

        #region 属性

        private string _heading = "香港选址工具";
        public string Heading
        {
            get { return _heading; }
            set { SetProperty(ref _heading, value, () => Heading); }
        }

        /// <summary>
        /// 约束条件数据集合
        /// </summary>
        private ObservableCollection<ConstraintDataItem> _constraintItems;
        public ObservableCollection<ConstraintDataItem> ConstraintItems
        {
            get { return _constraintItems; }
            set { SetProperty(ref _constraintItems, value, () => ConstraintItems); }
        }

        /// <summary>
        /// 分析区域路径
        /// </summary>
        private string _analysisAreaPath;
        public string AnalysisAreaPath
        {
            get { return _analysisAreaPath; }
            set { SetProperty(ref _analysisAreaPath, value, () => AnalysisAreaPath); }
        }

        /// <summary>
        /// POI数据集合
        /// </summary>
        private ObservableCollection<POIDataItem> _poiItems;
        public ObservableCollection<POIDataItem> POIItems
        {
            get { return _poiItems; }
            set { SetProperty(ref _poiItems, value, () => POIItems); }
        }

        /// <summary>
        /// 输出路径
        /// </summary>
        private string _outputPath;
        public string OutputPath
        {
            get { return _outputPath; }
            set { SetProperty(ref _outputPath, value, () => OutputPath); }
        }

        /// <summary>
        /// 权重和验证消息
        /// </summary>
        private string _weightSumValidationMessage;
        public string WeightSumValidationMessage
        {
            get { return _weightSumValidationMessage; }
            set { SetProperty(ref _weightSumValidationMessage, value, () => WeightSumValidationMessage); }
        }

        /// <summary>
        /// 权重和是否有效
        /// </summary>
        private bool _isWeightSumValid;
        public bool IsWeightSumValid
        {
            get { return _isWeightSumValid; }
            set { SetProperty(ref _isWeightSumValid, value, () => IsWeightSumValid); }
        }

        #endregion

        #region 命令

        /// <summary>
        /// 浏览约束条件数据命令
        /// </summary>
        public ICommand BrowseConstraintCommand { get; private set; }

        /// <summary>
        /// 浏览分析区域命令
        /// </summary>
        public ICommand BrowseAnalysisAreaCommand { get; private set; }

        /// <summary>
        /// 浏览POI数据命令
        /// </summary>
        public ICommand BrowsePOICommand { get; private set; }

        /// <summary>
        /// 浏览输出路径命令
        /// </summary>
        public ICommand BrowseOutputCommand { get; private set; }

        /// <summary>
        /// 运行分析命令
        /// </summary>
        public ICommand RunAnalysisCommand { get; private set; }

        #endregion

        #region 构造函数

        protected main_dockpaneViewModel()
        {
            InitializeCollections();
            InitializeCommands();
            SubscribeToPropertyChanges();
        }

        private void InitializeCollections()
        {
            // 初始化约束条件集合（5个空白行）
            ConstraintItems = new ObservableCollection<ConstraintDataItem>();
            for (int i = 0; i < 5; i++)
            {
                ConstraintItems.Add(new ConstraintDataItem());
            }

            // 初始化POI集合（2个空白行）
            POIItems = new ObservableCollection<POIDataItem>();
            POIItems.Add(new POIDataItem());
            POIItems.Add(new POIDataItem());
        }

        private void InitializeCommands()
        {
            BrowseConstraintCommand = new RelayCommand(BrowseConstraintData, () => true);
            BrowseAnalysisAreaCommand = new RelayCommand(BrowseAnalysisArea, () => true);
            BrowsePOICommand = new RelayCommand(BrowsePOIData, () => true);
            BrowseOutputCommand = new RelayCommand(BrowseOutputPath, () => true);
            RunAnalysisCommand = new RelayCommand(RunAnalysis, CanRunAnalysis);
        }

        private void SubscribeToPropertyChanges()
        {
            // 监听约束条件变化
            ConstraintItems.CollectionChanged += (s, e) => AutoAddEmptyRow(ConstraintItems);

            // 监听POI数据变化
            POIItems.CollectionChanged += (s, e) =>
            {
                AutoAddEmptyRow(POIItems);
                ValidateWeightSum();
            };
        }

        #endregion

        #region 方法

        /// <summary>
        /// 自动添加空白行
        /// </summary>
        private void AutoAddEmptyRow<T>(ObservableCollection<T> collection) where T : new()
        {
            // 检查是否所有行都已填充
            bool allFilled = true;
            foreach (var item in collection)
            {
                if (item is ConstraintDataItem constraint && constraint.IsEmpty)
                {
                    allFilled = false;
                    break;
                }
                else if (item is POIDataItem poi && poi.IsEmpty)
                {
                    allFilled = false;
                    break;
                }
            }

            // 如果所有行都已填充，添加新空白行
            if (allFilled)
            {
                collection.Add(new T());
            }
        }

        /// <summary>
        /// 验证权重和
        /// </summary>
        private void ValidateWeightSum()
        {
            var nonEmptyItems = POIItems.Where(p => !p.IsEmpty && p.Weight.HasValue).ToList();

            if (nonEmptyItems.Count == 0)
            {
                IsWeightSumValid = false;
                WeightSumValidationMessage = "";
                return;
            }

            double sum = nonEmptyItems.Sum(p => p.Weight.Value);

            if (Math.Abs(sum - 1.0) > 0.001) // 允许0.001的误差
            {
                IsWeightSumValid = true; // 显示消息
                WeightSumValidationMessage = $"警告: 权重之和为 {sum:F2}，应为 1.0";
            }
            else
            {
                IsWeightSumValid = false; // 隐藏消息
                WeightSumValidationMessage = "";
            }
        }

        /// <summary>
        /// 浏览约束条件数据
        /// </summary>
        private void BrowseConstraintData(object parameter)
        {
            var item = parameter as ConstraintDataItem;
            if (item == null) return;

            // 打开文件选择对话框
            var dialog = new Microsoft.Win32.OpenFileDialog
            {
                Filter = "Shapefile (*.shp)|*.shp|GeoDatabase Feature Class|*.gdb|All Files (*.*)|*.*",
                Title = "选择约束条件数据"
            };

            if (dialog.ShowDialog() == true)
            {
                item.DataPath = dialog.FileName;
            }
        }

        /// <summary>
        /// 浏览分析区域
        /// </summary>
        private void BrowseAnalysisArea()
        {
            var dialog = new Microsoft.Win32.OpenFileDialog
            {
                Filter = "Shapefile (*.shp)|*.shp|GeoDatabase Feature Class|*.gdb|All Files (*.*)|*.*",
                Title = "选择分析区域"
            };

            if (dialog.ShowDialog() == true)
            {
                AnalysisAreaPath = dialog.FileName;
            }
        }

        /// <summary>
        /// 浏览POI数据
        /// </summary>
        private void BrowsePOIData(object parameter)
        {
            var item = parameter as POIDataItem;
            if (item == null) return;

            var dialog = new Microsoft.Win32.OpenFileDialog
            {
                Filter = "所有支持格式|*.shp;*.tif;*.tiff;*.img|Shapefile (*.shp)|*.shp|Raster (*.tif;*.tiff;*.img)|*.tif;*.tiff;*.img|All Files (*.*)|*.*",
                Title = "选择POI数据或栅格"
            };

            if (dialog.ShowDialog() == true)
            {
                item.DataPath = dialog.FileName;
            }
        }

        /// <summary>
        /// 浏览输出路径
        /// </summary>
        private void BrowseOutputPath()
        {
            var dialog = new Microsoft.Win32.SaveFileDialog
            {
                Filter = "Shapefile (*.shp)|*.shp",
                Title = "选择输出路径",
                FileName = "Result_Rating_Suitable_Area.shp"
            };

            if (dialog.ShowDialog() == true)
            {
                OutputPath = dialog.FileName;
            }
        }

        /// <summary>
        /// 检查是否可以运行分析
        /// </summary>
        private bool CanRunAnalysis()
        {
            // 至少需要分析区域、一个POI数据、输出路径
            return !string.IsNullOrWhiteSpace(AnalysisAreaPath) &&
                   POIItems.Any(p => !p.IsEmpty) &&
                   !string.IsNullOrWhiteSpace(OutputPath);
        }

        /// <summary>
        /// 运行分析
        /// </summary>
        private void RunAnalysis()
        {
            // 验证权重和
            var nonEmptyPOI = POIItems.Where(p => !p.IsEmpty).ToList();
            double weightSum = nonEmptyPOI.Sum(p => p.Weight ?? 0);

            if (Math.Abs(weightSum - 1.0) > 0.001)
            {
                MessageBox.Show($"权重之和必须为1.0，当前为{weightSum:F2}", "验证失败");
                return;
            }

            // 这里调用后续的分析功能模块
            // TODO: 调用Divide、Distance、Rating模块

            MessageBox.Show("开始运行选址分析...", "提示");
        }

        #endregion

        #region DockPane方法

        internal static void Show()
        {
            DockPane pane = FrameworkApplication.DockPaneManager.Find(_dockPaneID);
            if (pane == null)
                return;

            pane.Activate();
        }

        #endregion
    }

    /// <summary>
    /// 按钮实现以显示DockPane
    /// </summary>
    internal class main_dockpane_ShowButton : Button
    {
        protected override void OnClick()
        {
            main_dockpaneViewModel.Show();
        }
    }
}
```

---

## 五、自定义距离间隔对话框设计

### 5.1 XAML (CustomIntervalDialog.xaml)

```xaml
<Window x:Class="HK_AREA_SEARCH.Views.CustomIntervalDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:extensions="clr-namespace:ArcGIS.Desktop.Extensions;assembly=ArcGIS.Desktop.Extensions"
        Title="自定义距离间隔"
        Height="450"
        Width="500"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <extensions:DesignOnlyResourceDictionary Source="pack://application:,,,/ArcGIS.Desktop.Framework;component\Themes\Default.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 数据名称标题 -->
        <TextBlock Grid.Row="0"
                   Text="{Binding DataName, StringFormat='数据: {0}'}"
                   FontSize="14"
                   FontWeight="Bold"
                   Margin="0,0,0,10"/>

        <!-- 分类表格 -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding IntervalClasses}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserReorderColumns="False"
                  CanUserSortColumns="False"
                  HeadersVisibility="Column"
                  GridLinesVisibility="All">

            <DataGrid.Columns>
                <DataGridTextColumn Header="开始"
                                    Binding="{Binding StartValue, StringFormat=F2}"
                                    Width="*"/>
                <DataGridTextColumn Header="结束"
                                    Binding="{Binding EndValue, StringFormat=F2}"
                                    Width="*"/>
                <DataGridTextColumn Header="类别"
                                    Binding="{Binding ClassValue}"
                                    Width="*"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- 确定按钮 -->
        <Button Grid.Row="2"
                Content="确定"
                Width="100"
                Height="30"
                HorizontalAlignment="Right"
                Margin="0,10,0,0"
                Click="OkButton_Click"
                Style="{DynamicResource Esri_Button}"/>
    </Grid>
</Window>
```

### 5.2 ViewModel (CustomIntervalDialogViewModel.cs)

```csharp
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Runtime.CompilerServices;
using HK_AREA_SEARCH.Models;

namespace HK_AREA_SEARCH.ViewModels
{
    /// <summary>
    /// 自定义距离间隔对话框ViewModel
    /// </summary>
    public class CustomIntervalDialogViewModel : INotifyPropertyChanged
    {
        private string _dataName;
        private ObservableCollection<IntervalClassItem> _intervalClasses;

        /// <summary>
        /// 数据名称
        /// </summary>
        public string DataName
        {
            get => _dataName;
            set
            {
                if (_dataName != value)
                {
                    _dataName = value;
                    OnPropertyChanged();
                }
            }
        }

        /// <summary>
        /// 分类间隔集合
        /// </summary>
        public ObservableCollection<IntervalClassItem> IntervalClasses
        {
            get => _intervalClasses;
            set
            {
                if (_intervalClasses != value)
                {
                    _intervalClasses = value;
                    OnPropertyChanged();
                }
            }
        }

        public CustomIntervalDialogViewModel(string dataName, bool isPositiveDistance)
        {
            DataName = dataName;
            InitializeDefaultIntervals(isPositiveDistance);
        }

        /// <summary>
        /// 初始化默认的相等间隔分类
        /// </summary>
        private void InitializeDefaultIntervals(bool isPositiveDistance)
        {
            IntervalClasses = new ObservableCollection<IntervalClassItem>();

            // 这里应该根据实际数据范围计算相等间隔
            // 示例：假设范围是0-1000米
            double minValue = 0;
            double maxValue = 1000;
            double interval = (maxValue - minValue) / 10;

            for (int i = 0; i < 10; i++)
            {
                int classValue = isPositiveDistance ? (10 - i) : (i + 1);

                IntervalClasses.Add(new IntervalClassItem
                {
                    StartValue = minValue + i * interval,
                    EndValue = minValue + (i + 1) * interval,
                    ClassValue = classValue
                });
            }
        }

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}
```

---

## 六、转换器设计

### 6.1 布尔值转"是/否"转换器

```csharp
using System;
using System.Globalization;
using System.Windows.Data;

namespace HK_AREA_SEARCH.Converters
{
    /// <summary>
    /// 布尔值转"是/否"转换器
    /// </summary>
    public class BooleanToYesNoConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool boolValue)
            {
                return boolValue ? "是" : "否";
            }
            return "否";
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is string strValue)
            {
                return strValue == "是";
            }
            return false;
        }
    }
}
```

---

## 七、拖放辅助类设计

### 7.1 DragDropHelper.cs

```csharp
using System.Windows;
using ArcGIS.Desktop.Mapping;

namespace HK_AREA_SEARCH.Helpers
{
    /// <summary>
    /// 拖放辅助类
    /// </summary>
    public static class DragDropHelper
    {
        /// <summary>
        /// 从拖放数据中提取图层路径
        /// </summary>
        public static string GetLayerPathFromDragDrop(DragEventArgs e)
        {
            // 检查是否为文件拖放
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                string[] files = (string[])e.Data.GetData(DataFormats.FileDrop);
                if (files != null && files.Length > 0)
                {
                    return files[0];
                }
            }

            // 检查是否为图层拖放（从ArcGIS Pro的TOC）
            if (e.Data.GetDataPresent("esri_map_layers"))
            {
                var layers = e.Data.GetData("esri_map_layers") as Layer[];
                if (layers != null && layers.Length > 0)
                {
                    var layer = layers[0];
                    // 获取图层数据源路径
                    if (layer is FeatureLayer featureLayer)
                    {
                        return featureLayer.GetFeatureClass().GetDatastore().GetPath();
                    }
                    else if (layer is RasterLayer rasterLayer)
                    {
                        return rasterLayer.GetRaster().GetDatastore().GetPath();
                    }
                }
            }

            return null;
        }

        /// <summary>
        /// 验证拖放的数据格式
        /// </summary>
        public static bool IsValidDragDropData(DragEventArgs e)
        {
            return e.Data.GetDataPresent(DataFormats.FileDrop) ||
                   e.Data.GetDataPresent("esri_map_layers");
        }
    }
}
```

---

## 八、代码隐藏文件 (main_dockpane.xaml.cs)

```csharp
using System.Windows;
using System.Windows.Controls;
using HK_AREA_SEARCH.Models;
using HK_AREA_SEARCH.Helpers;

namespace HK_AREA_SEARCH
{
    /// <summary>
    /// main_dockpaneView.xaml 的交互逻辑
    /// </summary>
    public partial class main_dockpaneView : UserControl
    {
        public main_dockpaneView()
        {
            InitializeComponent();
        }

        #region 约束条件拖放事件

        private void ConstraintItem_PreviewDragOver(object sender, DragEventArgs e)
        {
            if (DragDropHelper.IsValidDragDropData(e))
            {
                e.Effects = DragDropEffects.Copy;
                e.Handled = true;
            }
            else
            {
                e.Effects = DragDropEffects.None;
            }
        }

        private void ConstraintItem_Drop(object sender, DragEventArgs e)
        {
            var textBox = sender as TextBox;
            var item = textBox?.DataContext as ConstraintDataItem;

            if (item != null)
            {
                string path = DragDropHelper.GetLayerPathFromDragDrop(e);
                if (!string.IsNullOrEmpty(path))
                {
                    item.DataPath = path;
                }
            }

            e.Handled = true;
        }

        #endregion

        #region 分析区域拖放事件

        private void AnalysisArea_PreviewDragOver(object sender, DragEventArgs e)
        {
            if (DragDropHelper.IsValidDragDropData(e))
            {
                e.Effects = DragDropEffects.Copy;
                e.Handled = true;
            }
            else
            {
                e.Effects = DragDropEffects.None;
            }
        }

        private void AnalysisArea_Drop(object sender, DragEventArgs e)
        {
            var viewModel = DataContext as main_dockpaneViewModel;
            if (viewModel != null)
            {
                string path = DragDropHelper.GetLayerPathFromDragDrop(e);
                if (!string.IsNullOrEmpty(path))
                {
                    viewModel.AnalysisAreaPath = path;
                }
            }

            e.Handled = true;
        }

        #endregion

        #region POI拖放事件

        private void POIItem_PreviewDragOver(object sender, DragEventArgs e)
        {
            if (DragDropHelper.IsValidDragDropData(e))
            {
                e.Effects = DragDropEffects.Copy;
                e.Handled = true;
            }
            else
            {
                e.Effects = DragDropEffects.None;
            }
        }

        private void POIItem_Drop(object sender, DragEventArgs e)
        {
            var textBox = sender as TextBox;
            var item = textBox?.DataContext as POIDataItem;

            if (item != null)
            {
                string path = DragDropHelper.GetLayerPathFromDragDrop(e);
                if (!string.IsNullOrEmpty(path))
                {
                    item.DataPath = path;
                }
            }

            e.Handled = true;
        }

        #endregion
    }
}
```

---

## 九、自定义距离间隔对话框代码隐藏

```csharp
using System.Windows;
using HK_AREA_SEARCH.ViewModels;

namespace HK_AREA_SEARCH.Views
{
    /// <summary>
    /// CustomIntervalDialog.xaml 的交互逻辑
    /// </summary>
    public partial class CustomIntervalDialog : Window
    {
        public CustomIntervalDialogViewModel ViewModel { get; private set; }

        public CustomIntervalDialog(string dataName, bool isPositiveDistance)
        {
            InitializeComponent();

            ViewModel = new CustomIntervalDialogViewModel(dataName, isPositiveDistance);
            DataContext = ViewModel;
        }

        private void OkButton_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = true;
            Close();
        }
    }
}
```

---

## 十、关键实现说明

### 10.1 约束条件动态行管理
- 使用 `ObservableCollection` 自动管理集合变化
- 当所有行填充后自动添加新空白行
- 空白行不参与分析计算

### 10.2 POI表格验证
- **距离字段**: 栅格数据时自动禁用并置空
- **权重验证**: 实时计算总和并以红色提示
- **自定义间隔**: 下拉框选择后触发对话框

### 10.3 拖放功能
- 支持从Windows资源管理器拖放文件
- 支持从ArcGIS Pro图层目录（TOC）拖放图层
- 自动提取图层数据源路径

### 10.4 数据绑定
- 双向绑定确保UI与数据同步
- `UpdateSourceTrigger=PropertyChanged` 实现实时更新
- `INotifyPropertyChanged` 接口通知属性变化

### 10.5 自定义距离间隔对话框
- 弹出窗口显示默认相等间隔分类
- 用户可编辑每个类别的开始值、结束值
- 确定后将数据返回给主界面

---

## 十一、后续集成建议

1. **与功能模块集成**
   - 在 `RunAnalysis()` 方法中调用 Divide、Distance、Rating 模块
   - 传递界面收集的参数到各功能模块

2. **进度反馈**
   - 添加进度条显示分析进度
   - 使用异步操作避免界面冻结

3. **错误处理**
   - 添加文件路径验证
   - 添加数据格式验证
   - 提供友好的错误提示

4. **结果可视化**
   - 分析完成后自动添加结果图层到地图
   - 设置多级色彩符号系统
   - 以评分字段为分类标准

---

## 十二、界面效果对比

本设计方案完全符合 `图2界面设计.png` 的布局要求：

- ✅ 约束条件：支持批量输入、显示数据名称、文件图标、拖放功能
- ✅ 地区：单个输入框、文件图标
- ✅ POI表格：4列（输入数据、距离、权重、自定义距离间隔）
- ✅ 输出：单个路径选择
- ✅ 运行按钮：右下角定位

---

**方案完成日期**: 2025-10-04
